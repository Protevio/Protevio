<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="theme-color" content="#0f1219"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard â€” Protevio AI</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1219;--bg2:#161b26;--bg3:#1e2533;--bg4:#283042;
  --border:#2a3348;--border-h:#3a4868;
  --text:#f0f2f7;--text2:#c4c9d8;--text3:#8891a5;
  --accent:#5b9aff;--accent2:#3d7be8;
  --green:#34d399;--green-bg:rgba(52,211,153,.12);
  --red:#f87171;--red-bg:rgba(248,113,113,.12);
  --gold:#fbbf24;--gold-bg:rgba(251,191,36,.12);
  --purple:#a78bfa;--purple-bg:rgba(167,139,250,.12);
  --cyan:#22d3ee;--cyan-bg:rgba(34,211,238,.12);
  --mono:'JetBrains Mono',monospace;
  --sans:'Plus Jakarta Sans',sans-serif;
}
body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;display:flex}

/* SIDEBAR */
.sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50}
.sidebar__logo{display:flex;align-items:center;gap:10px;padding:20px;border-bottom:1px solid var(--border)}
.sidebar__logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--purple));border-radius:8px;display:flex;align-items:center;justify-content:center}
.sidebar__logo-icon svg{width:18px;height:18px;fill:#fff}
.sidebar__logo-text{font-weight:800;font-size:.95rem;letter-spacing:-.01em}
.sidebar__logo-sub{font-size:.65rem;color:var(--accent);font-weight:600;text-transform:uppercase;letter-spacing:.06em}
.sidebar__nav{flex:1;padding:12px 0}
.sidebar__section{padding:0 16px;margin-bottom:4px;font-size:.65rem;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;font-weight:600;margin-top:16px}
.sidebar__link{display:flex;align-items:center;gap:10px;padding:10px 16px;color:var(--text2);text-decoration:none;font-size:.85rem;font-weight:500;transition:all .15s;border-left:3px solid transparent;cursor:pointer}
.sidebar__link:hover{background:rgba(91,154,255,.06);color:var(--text)}
.sidebar__link.active{background:rgba(91,154,255,.1);color:var(--accent);border-left-color:var(--accent)}
.sidebar__link svg{width:18px;height:18px;stroke-width:2;fill:none;flex-shrink:0}
.sidebar__footer{padding:16px;border-top:1px solid var(--border)}
.sidebar__user{font-size:.82rem;font-weight:600;margin-bottom:2px}
.sidebar__role{font-size:.7rem;color:var(--accent);text-transform:uppercase;letter-spacing:.04em}
.sidebar__logout{margin-top:10px;background:none;border:1px solid var(--border);color:var(--red);width:100%;padding:8px;border-radius:8px;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;font-family:var(--sans)}
.sidebar__logout:hover{background:var(--red-bg);border-color:var(--red)}

/* MAIN */
.main{margin-left:240px;flex:1;min-height:100vh}
.topbar{padding:16px 28px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg2);position:sticky;top:0;z-index:40}
.topbar__title{font-size:1.1rem;font-weight:700}
.topbar__right{display:flex;align-items:center;gap:16px}
.topbar__status{display:flex;align-items:center;gap:6px;font-size:.78rem;color:var(--green);font-weight:600}
.topbar__status::before{content:'';width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.topbar__refresh{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 14px;border-radius:8px;font-size:.78rem;font-weight:600;cursor:pointer;font-family:var(--sans);transition:all .2s}
.topbar__refresh:hover{border-color:var(--accent);color:var(--accent)}
.topbar__time{font-size:.75rem;color:var(--text3);font-family:var(--mono)}

.content{padding:24px 28px}

/* PAGES */
.page{display:none}
.page.active{display:block}

/* CARDS */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:24px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;transition:all .2s}
.card:hover{border-color:var(--border-h)}
.card__top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.card__icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center}
.card__icon svg{width:20px;height:20px;stroke-width:2;fill:none}
.card__change{font-size:.72rem;font-weight:600;padding:3px 8px;border-radius:6px}
.card__value{font-size:1.7rem;font-weight:800;letter-spacing:-.02em;margin-bottom:2px;font-family:var(--mono)}
.card__label{font-size:.75rem;color:var(--text3);font-weight:500}

/* PANELS */
.panel{background:var(--bg2);border:1px solid var(--border);border-radius:14px;margin-bottom:20px;overflow:hidden}
.panel__header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.panel__title{font-size:.92rem;font-weight:700;display:flex;align-items:center;gap:8px}
.panel__title svg{width:16px;height:16px;stroke-width:2;fill:none;stroke:var(--accent)}
.panel__actions{display:flex;gap:8px}
.panel__btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:5px 12px;border-radius:7px;font-size:.75rem;font-weight:600;cursor:pointer;font-family:var(--sans);transition:all .15s}
.panel__btn:hover{border-color:var(--accent);color:var(--accent)}
.panel__btn.active{background:rgba(91,154,255,.15);border-color:var(--accent);color:var(--accent)}
.panel__body{padding:16px 20px}

/* TABLE */
.tbl{width:100%;border-collapse:collapse}
.tbl th{text-align:left;font-size:.7rem;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;font-weight:600;padding:10px 12px;border-bottom:1px solid var(--border)}
.tbl td{padding:10px 12px;font-size:.82rem;border-bottom:1px solid rgba(42,51,72,.5);vertical-align:middle}
.tbl tr:hover td{background:rgba(91,154,255,.03)}
.tbl tr:last-child td{border-bottom:none}

/* BADGES */
.badge{display:inline-flex;padding:3px 10px;border-radius:6px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em}
.badge--free{background:rgba(136,145,165,.15);color:var(--text3)}
.badge--basic{background:rgba(91,154,255,.15);color:var(--accent)}
.badge--pro{background:var(--purple-bg);color:var(--purple)}
.badge--unlimited{background:var(--gold-bg);color:var(--gold)}
.badge--admin{background:var(--red-bg);color:var(--red)}
.badge--user{background:var(--green-bg);color:var(--green)}
.badge--suspended{background:rgba(220,38,38,.2);color:#fca5a5;animation:suspPulse 2s ease-in-out infinite}
@keyframes suspPulse{0%,100%{opacity:1}50%{opacity:.6}}

/* GAUGE */
.gauge{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.gauge__bar{flex:1;height:8px;background:var(--bg4);border-radius:4px;overflow:hidden}
.gauge__fill{height:100%;border-radius:4px;transition:width .5s ease}
.gauge__label{font-size:.75rem;color:var(--text3);min-width:36px;text-align:right;font-family:var(--mono)}
.gauge__name{font-size:.8rem;min-width:50px}

/* BAR CHART (simple CSS) */
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.bar-row__label{font-size:.78rem;min-width:80px;color:var(--text2);text-align:right}
.bar-row__bar{flex:1;height:24px;background:var(--bg4);border-radius:6px;overflow:hidden;position:relative}
.bar-row__fill{height:100%;border-radius:6px;display:flex;align-items:center;padding:0 10px;font-size:.7rem;font-weight:700;color:#fff;min-width:fit-content;white-space:nowrap;transition:width .5s ease}
.bar-row__count{font-size:.75rem;color:var(--text3);min-width:60px;font-family:var(--mono)}

/* ACTION BTNS */
.act-btn{padding:4px 10px;border-radius:6px;font-size:.72rem;font-weight:600;cursor:pointer;border:1px solid;transition:all .15s;font-family:var(--sans);background:none}
.act-btn--blue{border-color:var(--accent);color:var(--accent)}
.act-btn--blue:hover{background:rgba(91,154,255,.15)}
.act-btn--red{border-color:var(--red);color:var(--red)}
.act-btn--red:hover{background:var(--red-bg)}
.act-btn--green{border-color:var(--green);color:var(--green)}
.act-btn--green:hover{background:var(--green-bg)}

/* SELECT */
.sel{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:6px;font-size:.75rem;font-family:var(--sans);cursor:pointer}
.sel:focus{outline:none;border-color:var(--accent)}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:200;justify-content:center;align-items:center;padding:20px}
.modal-overlay.active{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:16px;width:100%;max-width:480px;padding:24px;animation:modalIn .2s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.modal__title{font-size:1rem;font-weight:700;margin-bottom:16px}
.modal__field{margin-bottom:14px}
.modal__label{font-size:.75rem;color:var(--text3);margin-bottom:6px;display:block}
.modal__input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:8px;font-size:.85rem;font-family:var(--sans)}
.modal__input:focus{outline:none;border-color:var(--accent)}
.modal__btns{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
.modal__btn{padding:9px 20px;border-radius:9px;font-size:.85rem;font-weight:600;cursor:pointer;border:none;font-family:var(--sans);transition:all .15s}
.modal__btn--cancel{background:var(--bg3);color:var(--text2)}
.modal__btn--save{background:var(--accent);color:#fff}
.modal__btn--danger{background:var(--red);color:#fff}

/* EMPTY */
.empty{text-align:center;padding:40px;color:var(--text3);font-size:.88rem}

/* RESPONSIVE */
/* MOBILE TOPBAR */
.mobile-topbar{display:none;position:fixed;top:0;left:0;right:0;height:56px;background:var(--bg2);border-bottom:1px solid var(--border);z-index:90;align-items:center;padding:0 16px;gap:12px}
.mobile-topbar__hamburger{background:none;border:none;cursor:pointer;padding:8px;display:flex;flex-direction:column;gap:5px}
.mobile-topbar__hamburger span{display:block;width:20px;height:2px;background:var(--text);border-radius:2px;transition:all .3s}
.mobile-topbar__logo{display:flex;align-items:center;gap:8px;font-weight:800;font-size:.95rem;color:var(--text)}
.mobile-topbar__logo-icon{width:28px;height:28px;background:linear-gradient(135deg,var(--accent),#a78bfa);border-radius:7px;display:flex;align-items:center;justify-content:center}
.mobile-topbar__logo-icon svg{width:14px;height:14px;fill:#fff}
.mobile-topbar__label{font-size:.7rem;background:var(--red);color:#fff;padding:2px 8px;border-radius:6px;font-weight:700}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:95;backdrop-filter:blur(2px)}
.sidebar-overlay.show{display:block}

@media(max-width:768px){
  .mobile-topbar{display:flex}
  .sidebar{transform:translateX(-100%);transition:transform .3s ease;z-index:100;width:260px}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0}
  .content{padding:16px;padding-top:72px}
  .cards{grid-template-columns:1fr 1fr}
  .card__value{font-size:1.3rem}
  .table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{min-width:600px}
}
@media(max-width:500px){
  .cards{grid-template-columns:1fr}
  .content{padding:12px;padding-top:68px}
}
</style>
</head>
<body>

<!-- Mobile Topbar -->
<div class="mobile-topbar">
  <button class="mobile-topbar__hamburger" id="adminHamburger">
    <span></span><span></span><span></span>
  </button>
  <div class="mobile-topbar__logo">
    <div class="mobile-topbar__logo-icon"><svg viewBox="0 0 24 24"><path d="M15 3a6 6 0 00-6 6 6 6 0 006 6 6 6 0 006-6 6 6 0 00-6-6zM3 21a9 9 0 0118 0"/></svg></div>
    Protevio AI
    <span class="mobile-topbar__label">ADMIN</span>
  </div>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- SIDEBAR -->
<aside class="sidebar" id="adminSidebar">
  <div class="sidebar__logo">
    <div class="sidebar__logo-icon">
      <svg viewBox="0 0 24 24"><path d="M15 3a6 6 0 00-6 6 6 6 0 006 6 6 6 0 006-6 6 6 0 00-6-6zM3 21a9 9 0 0118 0"/></svg>
    </div>
    <div>
      <div class="sidebar__logo-text">Protevio AI</div>
      <div class="sidebar__logo-sub">Admin Panel</div>
    </div>
  </div>
  <nav class="sidebar__nav">
    <div class="sidebar__section">Overview</div>
    <a class="sidebar__link active" data-page="overview">
      <svg viewBox="0 0 24 24" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </a>
    <div class="sidebar__section">Management</div>
    <a class="sidebar__link" data-page="users">
      <svg viewBox="0 0 24 24" stroke="currentColor"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      Users
    </a>
    <a class="sidebar__link" data-page="domains">
      <svg viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10A15.3 15.3 0 0112 2z"/></svg>
      Domains
    </a>
    <a class="sidebar__link" data-page="messages">
      <svg viewBox="0 0 24 24" stroke="currentColor"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      Messages<span id="msgBadge" style="margin-left:auto;font-size:.65rem;background:var(--red);color:#fff;padding:1px 7px;border-radius:10px;font-weight:700;display:none">0</span>
    </a>
    <a class="sidebar__link" data-page="payments">
      <svg viewBox="0 0 24 24" stroke="currentColor"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>
      Payments
    </a>
    <a class="sidebar__link" data-page="optout">
      <svg viewBox="0 0 24 24" stroke="currentColor"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
      Opt-Out<span id="optoutBadge" style="margin-left:auto;font-size:.65rem;background:var(--gold);color:#000;padding:1px 7px;border-radius:10px;font-weight:700;display:none">0</span>
    </a>
    <div class="sidebar__section">Analytics</div>
    <a class="sidebar__link" data-page="searches">
      <svg viewBox="0 0 24 24" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      Search Log
    </a>
    <a class="sidebar__link" data-page="database">
      <svg viewBox="0 0 24 24" stroke="currentColor"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
      Database
    </a>
    <a class="sidebar__link" data-page="system">
      <svg viewBox="0 0 24 24" stroke="currentColor"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
      System
    </a>
    <div class="sidebar__section">Quick Links</div>
    <a class="sidebar__link" href="/" style="color:var(--text3)">
      <svg viewBox="0 0 24 24" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
      Go to Site
    </a>
  </nav>
  <div class="sidebar__footer">
    <div class="sidebar__user" id="sidebarUser">Admin</div>
    <div class="sidebar__role">Administrator</div>
    <button class="sidebar__logout" id="logoutBtn">Log Out</button>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar__title" id="pageTitle">Dashboard</div>
    <div class="topbar__right">
      <div class="topbar__status">System Online</div>
      <button class="topbar__refresh" onclick="loadAllData()">â†» Refresh</button>
      <div class="topbar__time" id="clock"></div>
    </div>
  </div>

  <div class="content">

    <!-- ===== OVERVIEW PAGE ===== -->
    <div class="page active" id="page-overview">
      <div class="cards" id="statsCards">
        <div class="card"><div class="card__top"><div class="card__icon" style="background:rgba(91,154,255,.12)"><svg viewBox="0 0 24 24" stroke="var(--accent)"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div></div><div class="card__value" id="statFaces">â€”</div><div class="card__label">Total Faces</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:var(--green-bg)"><svg viewBox="0 0 24 24" stroke="var(--green)"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10"/></svg></div></div><div class="card__value" id="statDomains">â€”</div><div class="card__label">Domains Crawled</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:var(--purple-bg)"><svg viewBox="0 0 24 24" stroke="var(--purple)"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg></div></div><div class="card__value" id="statUsers">â€”</div><div class="card__label">Registered Users</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:var(--gold-bg)"><svg viewBox="0 0 24 24" stroke="var(--gold)"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg></div></div><div class="card__value" id="statSearches">â€”</div><div class="card__label">Searches (24h)</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:var(--red-bg)"><svg viewBox="0 0 24 24" stroke="var(--red)"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg></div></div><div class="card__value" id="statSuspended">â€”</div><div class="card__label">Suspended</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:rgba(245,158,11,.12)"><svg viewBox="0 0 24 24" stroke="#f59e0b"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div></div><div class="card__value" id="statWarnings">â€”</div><div class="card__label">Minor Warnings</div></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
        <div class="panel">
          <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><path d="M12 20V10M18 20V4M6 20v-4"/></svg>System Resources</div></div>
          <div class="panel__body">
            <div class="gauge"><span class="gauge__name">CPU</span><div class="gauge__bar"><div class="gauge__fill" id="gaugeCpu" style="width:0;background:var(--accent)"></div></div><span class="gauge__label" id="gaugeCpuVal">â€”</span></div>
            <div class="gauge"><span class="gauge__name">RAM</span><div class="gauge__bar"><div class="gauge__fill" id="gaugeRam" style="width:0;background:var(--purple)"></div></div><span class="gauge__label" id="gaugeRamVal">â€”</span></div>
            <div class="gauge"><span class="gauge__name">Disk</span><div class="gauge__bar"><div class="gauge__fill" id="gaugeDisk" style="width:0;background:var(--gold)"></div></div><span class="gauge__label" id="gaugeDiskVal">â€”</span></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>Recent Searches</div></div>
          <div class="panel__body" id="recentSearches" style="max-height:180px;overflow-y:auto;font-size:.82rem">
            <div class="empty">Loading...</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Latest Users</div></div>
        <div class="panel__body" style="padding:0;overflow-x:auto">
          <table class="tbl">
            <thead><tr><th>Username</th><th>Email</th><th>Plan</th><th>Searches</th><th>Joined</th></tr></thead>
            <tbody id="latestUsersBody"><tr><td colspan="5" class="empty">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== USERS PAGE ===== -->
    <div class="page" id="page-users">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div style="font-size:.88rem;color:var(--text3);" id="userCount">0 users</div>
        <input type="text" placeholder="Search users..." id="userSearch" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:8px;font-size:.82rem;width:240px;font-family:var(--sans)">
      </div>
      <div class="panel">
        <div class="panel__body" style="padding:0;overflow-x:auto">
          <table class="tbl">
            <thead><tr><th>Username</th><th>Email</th><th>Name</th><th>Role</th><th>Plan</th><th>Searches</th><th>Warnings</th><th>Joined</th><th>Actions</th></tr></thead>
            <tbody id="usersBody"><tr><td colspan="9" class="empty">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== DOMAINS PAGE ===== -->
    <div class="page" id="page-domains">
      <div class="panel">
        <div class="panel__header">
          <div class="panel__title"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/></svg>Crawled Domains</div>
        </div>
        <div class="panel__body" id="domainsChart"></div>
        <div class="panel__body" style="padding:0;overflow-x:auto">
          <table class="tbl">
            <thead><tr><th>Domain</th><th>Faces</th><th>Avg Quality</th><th>Avg NSFW Score</th></tr></thead>
            <tbody id="domainsBody"><tr><td colspan="4" class="empty">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== SEARCH LOG PAGE ===== -->
    <div class="page" id="page-searches">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
        <div class="panel">
          <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><path d="M12 20V10M18 20V4M6 20v-4"/></svg>Searches Per Day (14d)</div></div>
          <div class="panel__body" id="dailySearchChart"></div>
        </div>
        <div class="panel">
          <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>Top Searchers</div></div>
          <div class="panel__body" id="topSearchers"></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>Search History</div></div>
        <div class="panel__body" style="padding:0;overflow-x:auto">
          <table class="tbl">
            <thead><tr><th>Time</th><th>User</th><th>Results</th></tr></thead>
            <tbody id="searchLogBody"><tr><td colspan="3" class="empty">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== DATABASE PAGE ===== -->
    <div class="page" id="page-database">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <div class="panel">
          <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Gender Distribution</div></div>
          <div class="panel__body" id="genderChart"></div>
        </div>
        <div class="panel">
          <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>Age Distribution</div></div>
          <div class="panel__body" id="ageChart"></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <div class="panel">
          <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>NSFW Categories</div></div>
          <div class="panel__body" id="nsfwChart"></div>
        </div>
        <div class="panel">
          <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/></svg>Quality Scores</div></div>
          <div class="panel__body" id="qualityStats"></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><path d="M12 20V10M18 20V4M6 20v-4"/></svg>Daily Face Intake (7d)</div></div>
        <div class="panel__body" id="intakeChart"></div>
      </div>
    </div>

    <!-- ===== SYSTEM PAGE ===== -->
    <div class="page" id="page-system">
      <div class="cards">
        <div class="card"><div class="card__value" id="sysCpu" style="font-size:2rem">â€”</div><div class="card__label">CPU Usage</div></div>
        <div class="card"><div class="card__value" id="sysRam" style="font-size:2rem">â€”</div><div class="card__label">Memory Usage</div></div>
        <div class="card"><div class="card__value" id="sysDisk" style="font-size:2rem">â€”</div><div class="card__label">Disk Usage</div></div>
      </div>
      <div class="panel">
        <div class="panel__header"><div class="panel__title"><svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>Server Information</div></div>
        <div class="panel__body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div style="padding:12px;background:var(--bg3);border-radius:10px"><div style="font-size:.7rem;color:var(--text3);margin-bottom:4px">HOSTNAME</div><div style="font-size:.85rem;font-family:var(--mono)">vmi3040742</div></div>
            <div style="padding:12px;background:var(--bg3);border-radius:10px"><div style="font-size:.7rem;color:var(--text3);margin-bottom:4px">API ENDPOINT</div><div style="font-size:.85rem;font-family:var(--mono)">api.protevio.com:5001</div></div>
            <div style="padding:12px;background:var(--bg3);border-radius:10px"><div style="font-size:.7rem;color:var(--text3);margin-bottom:4px">DATABASE</div><div style="font-size:.85rem;font-family:var(--mono)">PostgreSQL + pgvector</div></div>
            <div style="padding:12px;background:var(--bg3);border-radius:10px"><div style="font-size:.7rem;color:var(--text3);margin-bottom:4px">AI MODEL</div><div style="font-size:.85rem;font-family:var(--mono)">InsightFace ArcFace</div></div>
          </div>
        </div>
      </div>
    </div>

    <div class="page" id="page-messages">
      <div class="panel">
        <div class="panel__header">
          <div class="panel__title"><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Contact Messages</div>
          <div class="stat" id="msgCount" style="font-size:.82rem;color:var(--text2)">0 messages</div>
        </div>
        <div id="messagesContent" style="padding:16px"><div style="text-align:center;color:var(--text3);padding:32px">Loading messages...</div></div>
      </div>
    </div>

    <!-- ===== PAYMENTS PAGE ===== -->
    <div class="page" id="page-payments">
      <div class="cards" id="paymentCards">
        <div class="card"><div class="card__top"><div class="card__icon" style="background:rgba(34,197,94,.12)"><svg viewBox="0 0 24 24" stroke="#22c55e"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg></div></div><div class="card__value" id="payMRR">â‚¬0</div><div class="card__label">Monthly Revenue</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:rgba(91,154,255,.12)"><svg viewBox="0 0 24 24" stroke="var(--accent)"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg></div></div><div class="card__value" id="payActiveSubs">0</div><div class="card__label">Active Subscriptions</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:var(--gold-bg)"><svg viewBox="0 0 24 24" stroke="var(--gold)"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg></div></div><div class="card__value" id="payTotal">â‚¬0</div><div class="card__label">Total Revenue</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:var(--purple-bg)"><svg viewBox="0 0 24 24" stroke="var(--purple)"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div></div><div class="card__value" id="payRecent">0</div><div class="card__label">Payments (30d)</div></div>
      </div>
      <div class="panel">
        <div class="panel__header">
          <div class="panel__title"><svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>Recent Payments</div>
          <div class="stat" id="payCount" style="font-size:.82rem;color:var(--text2)">Loading...</div>
        </div>
        <div class="table-wrapper">
          <table class="tbl">
            <thead><tr><th>Customer</th><th>Email</th><th>Plan</th><th>Amount</th><th>Status</th><th>Date</th><th>Subscription</th></tr></thead>
            <tbody id="paymentsBody"><tr><td colspan="7" style="text-align:center;color:var(--text3);padding:32px">Loading payments...</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="panel" style="margin-top:20px">
        <div class="panel__header">
          <div class="panel__title"><svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>Active Subscribers</div>
        </div>
        <div class="table-wrapper">
          <table class="tbl">
            <thead><tr><th>Username</th><th>Email</th><th>Plan</th><th>Subscription ID</th><th>Since</th></tr></thead>
            <tbody id="subscribersBody"><tr><td colspan="5" style="text-align:center;color:var(--text3);padding:32px">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== OPT-OUT REQUESTS PAGE ===== -->
    <div class="page" id="page-optout">
      <div class="cards" id="optoutCards">
        <div class="card"><div class="card__top"><div class="card__icon" style="background:rgba(234,179,8,.12)"><svg viewBox="0 0 24 24" stroke="var(--gold)"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg></div></div><div class="card__value" id="optPending">0</div><div class="card__label">Pending Review</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:rgba(74,222,128,.12)"><svg viewBox="0 0 24 24" stroke="var(--green)"><path d="M20 6L9 17l-5-5"/></svg></div></div><div class="card__value" id="optApproved">0</div><div class="card__label">Approved</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:rgba(248,113,113,.12)"><svg viewBox="0 0 24 24" stroke="var(--red)"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg></div></div><div class="card__value" id="optRejected">0</div><div class="card__label">Rejected</div></div>
        <div class="card"><div class="card__top"><div class="card__icon" style="background:rgba(91,154,255,.12)"><svg viewBox="0 0 24 24" stroke="var(--accent)"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div></div><div class="card__value" id="optBlocklisted">-</div><div class="card__label">Blocklisted Faces</div></div>
      </div>

      <!-- Filter tabs -->
      <div style="display:flex;gap:6px;margin-bottom:16px">
        <button class="panel__btn active" id="optFilterPending" onclick="loadOptOut('pending')">Pending</button>
        <button class="panel__btn" id="optFilterApproved" onclick="loadOptOut('approved')">Approved</button>
        <button class="panel__btn" id="optFilterRejected" onclick="loadOptOut('rejected')">Rejected</button>
        <button class="panel__btn" id="optFilterAll" onclick="loadOptOut('all')">All</button>
      </div>

      <div class="panel">
        <div class="panel__header">
          <div class="panel__title"><svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>Opt-Out Requests</div>
          <div class="stat" id="optCount" style="font-size:.82rem;color:var(--text2)">Loading...</div>
        </div>
        <div id="optoutContent" style="padding:16px"><div style="text-align:center;color:var(--text3);padding:32px">Loading opt-out requests...</div></div>
      </div>
    </div>



  </div>
</div>

<!-- USER EDIT MODAL -->
<div class="modal-overlay" id="userModal">
  <div class="modal">
    <div class="modal__title" id="modalTitle">Edit User</div>
    <div class="modal__field"><label class="modal__label">Username</label><input class="modal__input" id="modalUsername" disabled></div>
    <div class="modal__field"><label class="modal__label">Email</label><input class="modal__input" id="modalEmail" disabled></div>
    <div class="modal__field"><label class="modal__label">Plan</label><select class="modal__input sel" id="modalPlan"><option value="free">Free</option><option value="basic">Basic (â‚¬25/mo)</option><option value="pro">Pro (â‚¬35/mo)</option><option value="unlimited">Unlimited (â‚¬300/mo)</option><option value="suspended">â›” Suspended</option></select></div>
    <div class="modal__field"><label class="modal__label">Role</label><select class="modal__input sel" id="modalRole"><option value="user">User</option><option value="admin">Admin</option></select></div>
    <div class="modal__btns">
      <button class="modal__btn modal__btn--danger" id="modalDeleteBtn">Delete User</button>
      <button class="modal__btn modal__btn--cancel" onclick="closeModal()">Cancel</button>
      <button class="modal__btn modal__btn--save" id="modalSaveBtn">Save Changes</button>
    </div>
  </div>
</div>


<script>
const API = 'https://api.protevio.com/api';
const token = localStorage.getItem('protevio_token');
const user = JSON.parse(localStorage.getItem('protevio_user') || '{}');

if(!token || user.role !== 'admin') {
  alert('Admin access required');
  window.location.href = '/login';
}

document.getElementById('sidebarUser').textContent = user.name || user.username || 'Admin';
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('protevio_token');
  localStorage.removeItem('protevio_user');
  window.location.href = '/login';
});

// Mobile sidebar toggle
const adminHamburger = document.getElementById('adminHamburger');
const adminSidebar = document.getElementById('adminSidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');
function openSidebar(){ adminSidebar.classList.add('open'); sidebarOverlay.classList.add('show'); document.body.style.overflow='hidden'; }
function closeSidebar(){ adminSidebar.classList.remove('open'); sidebarOverlay.classList.remove('show'); document.body.style.overflow=''; }
adminHamburger.addEventListener('click', openSidebar);
sidebarOverlay.addEventListener('click', closeSidebar);

// Clock
setInterval(() => {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-GB');
}, 1000);

// Navigation
document.querySelectorAll('.sidebar__link[data-page]').forEach(link => {
  link.addEventListener('click', () => {
    document.querySelectorAll('.sidebar__link').forEach(l => l.classList.remove('active'));
    link.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + link.dataset.page).classList.add('active');
    document.getElementById('pageTitle').textContent = link.textContent.trim();
    closeSidebar();
  });
});

// API helper
async function api(path) {
  const res = await fetch(API + path, { headers: {'Authorization': 'Bearer ' + token} });
  if(res.status === 401) { window.location.href = '/login'; return null; }
  return res.json();
}
async function apiPost(path, body) {
  const res = await fetch(API + path, {
    method: 'POST', headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  return res.json();
}
async function apiPut(path, body) {
  const res = await fetch(API + path, {
    method: 'PUT', headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  return res.json();
}
async function apiDel(path) {
  const res = await fetch(API + path, { method: 'DELETE', headers: {'Authorization': 'Bearer ' + token} });
  return res.json();
}

function fmt(n) { return n != null ? Number(n).toLocaleString() : 'â€”'; }
function timeAgo(str) {
  const d = new Date(str);
  const s = Math.floor((Date.now() - d) / 1000);
  if(s < 60) return s + 's ago';
  if(s < 3600) return Math.floor(s/60) + 'm ago';
  if(s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}

// Helper: make bar chart
function barChart(container, data, colorFn) {
  const max = Math.max(...data.map(d => d.value), 1);
  container.innerHTML = data.map(d => {
    const pct = Math.max(2, (d.value / max) * 100);
    const color = colorFn ? colorFn(d) : 'var(--accent)';
    return '<div class="bar-row"><div class="bar-row__label">' + d.label + '</div><div class="bar-row__bar"><div class="bar-row__fill" style="width:' + pct + '%;background:' + color + '">' + fmt(d.value) + '</div></div></div>';
  }).join('');
}

// ===== LOAD DATA =====
let allUsers = [];

async function loadAllData() {
  loadStats();
  loadUsers();
  loadSearchLog();
  loadDomains();
  loadFaceStats();
  loadAnalytics();
  loadMessages();
  loadPayments();
}

async function loadStats() {
  const d = await api('/admin/stats');
  if(!d) return;
  document.getElementById('statFaces').textContent = fmt(d.faces);
  document.getElementById('statDomains').textContent = fmt(d.domains);
  document.getElementById('statUsers').textContent = fmt(d.users);
  document.getElementById('statSearches').textContent = fmt(d.searches_24h);
  document.getElementById('statSuspended').textContent = fmt(d.suspended_users || 0);
  document.getElementById('statWarnings').textContent = fmt(d.minor_warnings || 0);

  const cpu = d.cpu || 0, ram = d.memory || 0, disk = d.disk || 0;
  document.getElementById('gaugeCpu').style.width = cpu + '%';
  document.getElementById('gaugeCpuVal').textContent = cpu + '%';
  document.getElementById('gaugeRam').style.width = ram + '%';
  document.getElementById('gaugeRamVal').textContent = ram + '%';
  document.getElementById('gaugeDisk').style.width = disk + '%';
  document.getElementById('gaugeDiskVal').textContent = disk + '%';

  // Color coding
  ['Cpu','Ram','Disk'].forEach((g, i) => {
    const v = [cpu, ram, disk][i];
    const c = v > 80 ? 'var(--red)' : v > 60 ? 'var(--gold)' : ['var(--accent)','var(--purple)','var(--gold)'][i];
    document.getElementById('gauge' + g).style.background = c;
  });

  document.getElementById('sysCpu').textContent = cpu + '%';
  document.getElementById('sysRam').textContent = ram + '%';
  document.getElementById('sysDisk').textContent = disk + '%';
}

async function loadUsers() {
  const d = await api('/admin/users');
  if(!d) return;
  allUsers = d.users || [];
  document.getElementById('userCount').textContent = allUsers.length + ' users';
  renderUsers(allUsers);
  renderLatestUsers(allUsers.slice(0, 5));
}

function renderUsers(users) {
  const body = document.getElementById('usersBody');
  if(!users.length) { body.innerHTML = '<tr><td colspan="9" class="empty">No users found</td></tr>'; return; }
  body.innerHTML = users.map(u => {
    const isSuspended = u.plan === 'suspended';
    const isAdmin = u.role === 'admin';
    const warnBadge = (u.minor_warnings || 0) > 0 ? `<span class="badge badge--admin">${u.minor_warnings}</span>` : '<span style="color:var(--text3)">0</span>';
    const suspendBtn = isAdmin ? '' : (isSuspended
      ? `<button class="act-btn act-btn--green" onclick="toggleSuspend('${u.username}',false)" title="Unsuspend">Unsuspend</button>`
      : `<button class="act-btn act-btn--red" onclick="toggleSuspend('${u.username}',true)" title="Suspend">Suspend</button>`);
    return `<tr${isSuspended ? ' style="background:rgba(220,38,38,.04)"' : ''}>
    <td style="font-weight:600">${u.username}</td>
    <td style="color:var(--text2)">${u.email || 'â€”'}</td>
    <td>${u.name || 'â€”'}</td>
    <td><span class="badge badge--${u.role}">${u.role}</span></td>
    <td><span class="badge badge--${u.plan}">${u.plan}</span></td>
    <td style="font-family:var(--mono)">${fmt(u.searches)}</td>
    <td>${warnBadge}</td>
    <td style="color:var(--text3);font-size:.78rem">${u.created ? u.created.split('.')[0] : 'â€”'}</td>
    <td style="display:flex;gap:4px"><button class="act-btn act-btn--blue" onclick="editUser('${u.username}')">Edit</button>${suspendBtn}</td>
  </tr>`;
  }).join('');
}

function renderLatestUsers(users) {
  const body = document.getElementById('latestUsersBody');
  body.innerHTML = users.map(u => `<tr>
    <td style="font-weight:600">${u.username}</td>
    <td style="color:var(--text2)">${u.email || 'â€”'}</td>
    <td><span class="badge badge--${u.plan}">${u.plan}</span></td>
    <td style="font-family:var(--mono)">${fmt(u.searches)}</td>
    <td style="color:var(--text3);font-size:.78rem">${u.created ? u.created.split('.')[0] : 'â€”'}</td>
  </tr>`).join('');
}

// User search filter
document.getElementById('userSearch').addEventListener('input', (e) => {
  const q = e.target.value.toLowerCase();
  const filtered = allUsers.filter(u =>
    (u.username||'').toLowerCase().includes(q) ||
    (u.email||'').toLowerCase().includes(q) ||
    (u.name||'').toLowerCase().includes(q)
  );
  renderUsers(filtered);
});

// Edit user modal
let editingUser = null;
function editUser(username) {
  editingUser = allUsers.find(u => u.username === username);
  if(!editingUser) return;
  document.getElementById('modalTitle').textContent = 'Edit User: ' + username;
  document.getElementById('modalUsername').value = editingUser.username;
  document.getElementById('modalEmail').value = editingUser.email || '';
  document.getElementById('modalPlan').value = editingUser.plan || 'free';
  document.getElementById('modalRole').value = editingUser.role || 'user';
  document.getElementById('modalDeleteBtn').style.display = username === 'admin' ? 'none' : 'block';
  document.getElementById('userModal').classList.add('active');
}
function closeModal() { document.getElementById('userModal').classList.remove('active'); editingUser = null; }
document.getElementById('userModal').addEventListener('click', (e) => { if(e.target === document.getElementById('userModal')) closeModal(); });

document.getElementById('modalSaveBtn').addEventListener('click', async () => {
  if(!editingUser) return;
  const plan = document.getElementById('modalPlan').value;
  const role = document.getElementById('modalRole').value;
  await apiPut('/admin/users/' + editingUser.username + '/plan', { plan });
  if(role !== editingUser.role) {
    await apiPut('/admin/users/' + editingUser.username + '/role', { role });
  }
  closeModal();
  loadUsers();
});

document.getElementById('modalDeleteBtn').addEventListener('click', async () => {
  if(!editingUser || editingUser.username === 'admin') return;
  if(!confirm('Delete user "' + editingUser.username + '"? This cannot be undone.')) return;
  await apiDel('/admin/users/' + editingUser.username);
  closeModal();
  loadUsers();
});

async function toggleSuspend(username, suspend) {
  const action = suspend ? 'suspend' : 'unsuspend';
  const msg = suspend
    ? 'Suspend "' + username + '"? They will be blocked from all searches and redirected to a suspension page.'
    : 'Unsuspend "' + username + '"? Their account will be reset to the free plan.';
  if(!confirm(msg)) return;
  await apiPost('/admin/users/' + username + '/' + action);
  loadUsers();
  loadStats();
}

async function loadSearchLog() {
  const d = await api('/admin/search-log?limit=50');
  if(!d) return;
  const logs = d.logs || [];

  // Recent searches in overview
  const recent = document.getElementById('recentSearches');
  if(logs.length === 0) { recent.innerHTML = '<div class="empty">No searches yet</div>'; }
  else {
    recent.innerHTML = logs.slice(0, 8).map(l =>
      '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(42,51,72,.4)">' +
      '<div><span style="font-weight:600">' + l.username + '</span> <span style="color:var(--text3)">â†’ ' + l.results + ' results</span></div>' +
      '<span style="font-size:.72rem;color:var(--text3)">' + timeAgo(l.time) + '</span></div>'
    ).join('');
  }

  // Full table
  const body = document.getElementById('searchLogBody');
  if(logs.length === 0) { body.innerHTML = '<tr><td colspan="3" class="empty">No searches yet</td></tr>'; return; }
  body.innerHTML = logs.map(l => `<tr>
    <td style="font-size:.78rem;color:var(--text3);font-family:var(--mono)">${l.time ? l.time.split('.')[0] : 'â€”'}</td>
    <td style="font-weight:600">${l.username}</td>
    <td style="font-family:var(--mono)">${l.results}</td>
  </tr>`).join('');
}

async function loadDomains() {
  const d = await api('/admin/domains');
  if(!d) return;
  const domains = d.domains || [];

  // Chart
  const top10 = domains.slice(0, 10);
  barChart(document.getElementById('domainsChart'), top10.map(d => ({label: d.domain, value: d.faces})),
    () => 'linear-gradient(90deg, var(--accent), var(--purple))');

  // Table
  const body = document.getElementById('domainsBody');
  body.innerHTML = domains.map(d => `<tr>
    <td style="font-weight:600">${d.domain}</td>
    <td style="font-family:var(--mono)">${fmt(d.faces)}</td>
    <td>${d.avg_quality}</td>
    <td>${d.avg_nsfw}</td>
  </tr>`).join('');
}

async function loadFaceStats() {
  const d = await api('/admin/face-stats');
  if(!d) return;

  // Gender
  const genderData = Object.entries(d.gender || {}).map(([k,v]) => ({label: k === 'M' ? 'Male' : k === 'F' ? 'Female' : k, value: v}));
  barChart(document.getElementById('genderChart'), genderData, (d) => d.label === 'Male' ? 'var(--accent)' : d.label === 'Female' ? 'var(--purple)' : 'var(--text3)');

  // Age
  const ageData = Object.entries(d.age || {}).map(([k,v]) => ({label: k, value: v}));
  barChart(document.getElementById('ageChart'), ageData, () => 'var(--green)');

  // NSFW
  const nsfwColors = {unknown:'var(--text3)', safe:'var(--green)', suggestive:'var(--gold)', explicit:'var(--red)', neutral:'var(--accent)'};
  const nsfwData = Object.entries(d.nsfw || {}).map(([k,v]) => ({label: k, value: v}));
  barChart(document.getElementById('nsfwChart'), nsfwData, (d) => nsfwColors[d.label] || 'var(--text3)');

  // Quality
  const q = d.quality || {};
  document.getElementById('qualityStats').innerHTML = `
    <div class="gauge"><span class="gauge__name" style="min-width:100px">Avg Quality</span><div class="gauge__bar"><div class="gauge__fill" style="width:${(q.avg_quality||0)*100}%;background:var(--green)"></div></div><span class="gauge__label">${q.avg_quality||0}</span></div>
    <div class="gauge"><span class="gauge__name" style="min-width:100px">Avg Detection</span><div class="gauge__bar"><div class="gauge__fill" style="width:${(q.avg_detection||0)*100}%;background:var(--accent)"></div></div><span class="gauge__label">${q.avg_detection||0}</span></div>
    <div class="gauge"><span class="gauge__name" style="min-width:100px">Avg Blur</span><div class="gauge__bar"><div class="gauge__fill" style="width:${(q.avg_blur||0)*100}%;background:var(--gold)"></div></div><span class="gauge__label">${q.avg_blur||0}</span></div>
  `;

  // Daily intake
  const intake = d.daily_intake || [];
  if(intake.length) {
    barChart(document.getElementById('intakeChart'), intake.map(d => ({label: d.date, value: d.count})), () => 'linear-gradient(90deg, var(--cyan), var(--accent))');
  } else {
    document.getElementById('intakeChart').innerHTML = '<div class="empty">No recent crawl data</div>';
  }
}

async function loadAnalytics() {
  const d = await api('/admin/analytics');
  if(!d) return;

  // Daily searches chart
  const daily = d.daily || [];
  if(daily.length) {
    barChart(document.getElementById('dailySearchChart'), daily.map(d => ({label: d.date.slice(5), value: d.searches})), () => 'var(--accent)');
  } else {
    document.getElementById('dailySearchChart').innerHTML = '<div class="empty">No search data yet</div>';
  }

  // Top searchers
  const top = d.top_searchers || [];
  if(top.length) {
    barChart(document.getElementById('topSearchers'), top.map(t => ({label: t.username, value: t.searches})), () => 'var(--purple)');
  } else {
    document.getElementById('topSearchers').innerHTML = '<div class="empty">No search data yet</div>';
  }
}

// Load everything
async function loadMessages() {
  const d = await api('/admin/messages');
  if(!d) return;
  const msgs = d.messages || [];
  const el = document.getElementById('messagesContent');
  const badge = document.getElementById('msgBadge');
  const unread = msgs.filter(m => !m.read).length;
  
  document.getElementById('msgCount').textContent = msgs.length + ' message' + (msgs.length !== 1 ? 's' : '') + (unread ? ' (' + unread + ' unread)' : '');
  if(unread > 0) { badge.textContent = unread; badge.style.display = 'inline'; }
  
  if(msgs.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:var(--text3);padding:32px">No messages yet</div>';
    return;
  }
  
  el.innerHTML = msgs.map(m => `
    <div style="padding:16px;background:var(--bg3);border-radius:12px;margin-bottom:10px;border-left:3px solid ${m.read ? 'var(--border)' : 'var(--accent)'};transition:all .2s">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div>
          <span style="font-weight:700;font-size:.88rem">${esc(m.name)}</span>
          <a href="mailto:${esc(m.email)}" style="color:var(--accent);font-size:.78rem;margin-left:8px;text-decoration:none">${esc(m.email)}</a>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:.7rem;color:var(--text3)">${new Date(m.created_at).toLocaleString()}</span>
          ${!m.read ? '<span style="font-size:.6rem;background:var(--accent-bg);color:var(--accent);padding:2px 8px;border-radius:6px;font-weight:700">NEW</span>' : ''}
        </div>
      </div>
      <div style="font-size:.85rem;font-weight:600;color:var(--text);margin-bottom:6px">${esc(m.subject)}</div>
      <div style="font-size:.82rem;color:var(--text2);line-height:1.6;white-space:pre-wrap">${esc(m.message)}</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        ${!m.read ? `<button onclick="markRead(${m.id})" style="font-size:.75rem;padding:4px 12px;border-radius:6px;border:1px solid var(--accent);color:var(--accent);background:none;cursor:pointer;font-family:inherit">Mark Read</button>` : ''}
        <a href="mailto:${esc(m.email)}?subject=Re: ${encodeURIComponent(m.subject)}" style="font-size:.75rem;padding:4px 12px;border-radius:6px;border:1px solid var(--green);color:var(--green);text-decoration:none;display:inline-block">Reply</a>
        <button onclick="deleteMsg(${m.id})" style="font-size:.75rem;padding:4px 12px;border-radius:6px;border:1px solid var(--red);color:var(--red);background:none;cursor:pointer;font-family:inherit">Delete</button>
      </div>
    </div>
  `).join('');
}

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

async function markRead(id) {
  await apiPost('/admin/messages/' + id + '/read', {});
  loadMessages();
}

async function deleteMsg(id) {
  if(!confirm('Delete this message?')) return;
  await apiDel('/admin/messages/' + id);
  loadMessages();
}

// ===== PAYMENTS =====
async function loadPayments() {
  try {
    const d = await api('/admin/payments');
    if (!d) return;

    // Summary cards
    document.getElementById('payMRR').textContent = 'â‚¬' + (d.mrr || 0).toFixed(2);
    document.getElementById('payActiveSubs').textContent = d.active_subscriptions || 0;
    document.getElementById('payTotal').textContent = 'â‚¬' + (d.total_revenue || 0).toFixed(2);
    document.getElementById('payRecent').textContent = d.recent_count || 0;
    document.getElementById('payCount').textContent = (d.payments || []).length + ' payments';

    // Payments table
    const body = document.getElementById('paymentsBody');
    if (!d.payments || !d.payments.length) {
      body.innerHTML = '<tr><td colspan="7" class="empty">No payments yet</td></tr>';
    } else {
      body.innerHTML = d.payments.map(p => {
        const statusColor = p.status === 'paid' ? 'var(--green)' : p.status === 'open' ? 'var(--gold)' : 'var(--red)';
        const planBadge = p.plan ? `<span class="badge badge--${p.plan}">${p.plan}</span>` : 'â€”';
        const date = p.date ? new Date(p.date * 1000).toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'â€”';
        return `<tr>
          <td style="font-weight:600">${p.username || p.customer_name || 'â€”'}</td>
          <td style="color:var(--text2)">${p.email || 'â€”'}</td>
          <td>${planBadge}</td>
          <td style="font-weight:600;color:var(--green)">â‚¬${(p.amount || 0).toFixed(2)}</td>
          <td><span style="color:${statusColor};font-weight:600;font-size:.8rem">${(p.status || '').toUpperCase()}</span></td>
          <td style="color:var(--text3);font-size:.78rem">${date}</td>
          <td style="font-family:var(--mono);font-size:.72rem;color:var(--text3)">${p.subscription_id ? p.subscription_id.slice(-8) : 'â€”'}</td>
        </tr>`;
      }).join('');
    }

    // Subscribers table
    const subBody = document.getElementById('subscribersBody');
    if (!d.subscribers || !d.subscribers.length) {
      subBody.innerHTML = '<tr><td colspan="5" class="empty">No active subscribers</td></tr>';
    } else {
      subBody.innerHTML = d.subscribers.map(s => `<tr>
        <td style="font-weight:600">${s.username}</td>
        <td style="color:var(--text2)">${s.email || 'â€”'}</td>
        <td><span class="badge badge--${s.plan}">${s.plan}</span></td>
        <td style="font-family:var(--mono);font-size:.75rem;color:var(--text3)">${s.stripe_subscription_id || 'â€”'}</td>
        <td style="color:var(--text3);font-size:.78rem">${s.created ? s.created.split('.')[0] : 'â€”'}</td>
      </tr>`).join('');
    }
  } catch(e) {
    console.error('Failed to load payments:', e);
    document.getElementById('paymentsBody').innerHTML = '<tr><td colspan="7" class="empty">Failed to load payments</td></tr>';
  }
}

// ===== OPT-OUT REQUESTS =====
let currentOptFilter = 'pending';

async function loadOptOut(status) {
  status = status || currentOptFilter;
  currentOptFilter = status;

  // Update filter button states
  document.querySelectorAll('[id^="optFilter"]').forEach(b => b.classList.remove('active'));
  const filterBtn = document.getElementById('optFilter' + status.charAt(0).toUpperCase() + status.slice(1));
  if(filterBtn) filterBtn.classList.add('active');

  const d = await api('/admin/opt-out-requests?status=' + status);
  if(!d) return;

  const reqs = d.requests || [];
  const counts = d.counts || {};
  const el = document.getElementById('optoutContent');
  const badge = document.getElementById('optoutBadge');
  const pending = counts.pending || 0;

  // Update stat cards
  document.getElementById('optPending').textContent = fmt(counts.pending || 0);
  document.getElementById('optApproved').textContent = fmt(counts.approved || 0);
  document.getElementById('optRejected').textContent = fmt(counts.rejected || 0);

  document.getElementById('optCount').textContent = reqs.length + ' request' + (reqs.length !== 1 ? 's' : '');

  // Show badge for pending
  if(pending > 0) { badge.textContent = pending; badge.style.display = 'inline'; }
  else { badge.style.display = 'none'; }

  if(reqs.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:var(--text3);padding:32px">No ' + status + ' requests</div>';
    return;
  }

  el.innerHTML = reqs.map(r => {
    const statusColors = {pending:'var(--gold)',approved:'var(--green)',rejected:'var(--red)'};
    const borderColor = statusColors[r.status] || 'var(--border)';
    const isPending = r.status === 'pending';

    return `
    <div style="padding:16px;background:var(--bg3);border-radius:12px;margin-bottom:12px;border-left:3px solid ${borderColor}">
      <div style="display:flex;gap:16px;align-items:flex-start">
        <!-- Face photo -->
        <div style="flex-shrink:0">
          ${r.face_photo ? `<img src="${esc(r.face_photo)}" style="width:64px;height:64px;border-radius:10px;object-fit:cover;border:2px solid ${borderColor}">` : '<div style="width:64px;height:64px;border-radius:10px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:.7rem;color:var(--text3)">No photo</div>'}
        </div>
        <!-- Info -->
        <div style="flex:1;min-width:0">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;flex-wrap:wrap;gap:6px">
            <div>
              <span style="font-weight:700;font-size:.92rem">${esc(r.name)}</span>
              <a href="mailto:${esc(r.email)}" style="color:var(--accent);font-size:.78rem;margin-left:8px;text-decoration:none">${esc(r.email)}</a>
            </div>
            <div style="display:flex;align-items:center;gap:6px">
              <span style="font-size:.65rem;background:${borderColor};color:${r.status==='pending'?'#000':'#fff'};padding:2px 8px;border-radius:6px;font-weight:700;text-transform:uppercase">${r.status}</span>
              <span style="font-size:.7rem;color:var(--text3)">#${r.id}</span>
            </div>
          </div>
          <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:.78rem;color:var(--text3);margin-bottom:8px">
            <span><strong style="color:var(--accent)">${r.matches_found}</strong> faces matched</span>
            <span>Reason: ${esc(r.reason || 'Not specified')}</span>
            <span>IP: ${esc(r.ip_address || 'Unknown')}</span>
            <span>${r.created_at ? new Date(r.created_at).toLocaleString() : ''}</span>
          </div>
          <!-- ID Photo link -->
          <div style="margin-bottom:8px">
            <button onclick="viewIdPhoto(${r.id})" style="font-size:.75rem;padding:4px 12px;border-radius:6px;border:1px solid var(--gold);color:var(--gold);background:none;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:4px">
              <svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2"><rect x="2" y="5" width="20" height="14" rx="2"/><circle cx="8" cy="12" r="2"/><path d="M14 10h4M14 14h2"/></svg>
              View Redacted ID
            </button>
            ${r.admin_notes ? `<span style="font-size:.75rem;color:var(--text3);margin-left:8px">Note: ${esc(r.admin_notes)}</span>` : ''}
            ${r.reviewed_by ? `<span style="font-size:.72rem;color:var(--text3);margin-left:8px">Reviewed by ${esc(r.reviewed_by)} at ${r.reviewed_at ? new Date(r.reviewed_at).toLocaleString() : ''}</span>` : ''}
          </div>
          <!-- Actions -->
          ${isPending ? `
          <div style="display:flex;gap:8px;margin-top:6px">
            <button onclick="approveOptOut(${r.id}, '${esc(r.name)}', ${r.matches_found})" style="font-size:.75rem;padding:5px 14px;border-radius:6px;border:none;background:var(--green);color:#000;cursor:pointer;font-family:inherit;font-weight:600">Approve &amp; Delete ${r.matches_found} faces</button>
            <button onclick="rejectOptOut(${r.id}, '${esc(r.name)}')" style="font-size:.75rem;padding:5px 14px;border-radius:6px;border:1px solid var(--red);color:var(--red);background:none;cursor:pointer;font-family:inherit;font-weight:600">Reject</button>
          </div>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

async function viewIdPhoto(id) {
  const url = API + '/admin/opt-out-id-photo/' + id;
  try {
    const res = await fetch(url, {headers:{'Authorization':'Bearer '+token}});
    if(!res.ok) throw new Error('Not found');
    const blob = await res.blob();
    const objUrl = URL.createObjectURL(blob);
    const w = window.open('', 'idphoto_'+id, 'width=650,height=500,scrollbars=yes');
    w.document.write('<html><head><title>ID Photo - Request #'+id+'</title>'+
      '<style>body{margin:0;background:#1a1f2e;display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:16px}'+
      'img{max-width:95%;max-height:85vh;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.5)}'+
      '.warn{background:rgba(234,179,8,.15);border:1px solid rgba(234,179,8,.3);color:#d97706;padding:8px 20px;border-radius:8px;font:13px/1.4 system-ui;text-align:center;margin-top:16px}</style></head>'+
      '<body><div class="warn">&#9888; Confidential &mdash; Verify face &amp; name match the request</div>'+
      '<img src="'+objUrl+'"></body></html>');
  } catch(e) {
    alert('Failed to load ID photo. It may have been deleted or the request was already processed.');
  }
}

async function approveOptOut(id, name, matchCount) {
  const notes = prompt(`Approve opt-out for ${name}?\n\n${matchCount} faces will be permanently deleted and the face will be blocklisted.\n\nOptional admin note:`, '');
  if(notes === null) return; // cancelled

  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Processing...';

  try {
    const d = await apiPost('/admin/opt-out/' + id + '/approve', {notes: notes});
    if(d.success) {
      alert(`Approved! ${d.removed_count} faces removed and face blocklisted. User notified via email.`);
      loadOptOut();
    } else {
      alert('Error: ' + (d.error || 'Unknown error'));
      btn.disabled = false;
      btn.textContent = 'Approve';
    }
  } catch(e) {
    alert('Failed: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Approve';
  }
}

async function rejectOptOut(id, name) {
  const reason = prompt(`Reject opt-out for ${name}?\n\nProvide a reason (will be sent to the user):`, 'Identity could not be verified from the provided ID. Please resubmit with a clearer photo.');
  if(reason === null) return; // cancelled

  try {
    const d = await apiPost('/admin/opt-out/' + id + '/reject', {notes: reason});
    if(d.success) {
      alert('Rejected. User notified via email.');
      loadOptOut();
    } else {
      alert('Error: ' + (d.error || 'Unknown error'));
    }
  } catch(e) {
    alert('Failed: ' + e.message);
  }
}


loadAllData();

// Auto-refresh every 30s
setInterval(loadStats, 30000);
</script>
</body>
</html>
