<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Search Results — Protevio AI</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%235b9aff' rx='20' width='100' height='100'/><text x='50' y='68' text-anchor='middle' fill='white' font-size='55' font-weight='800' font-family='system-ui'>P</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0e1a;
  --bg-surface:#111827;
  --bg-card:#161d2f;
  --bg-card-hover:#1c2540;
  --border:#1e293b;
  --border-hover:#2a3959;
  --text:#f0f2f7;
  --text-secondary:#c8cdd8;
  --text-muted:#6b7280;
  --accent:#5b9aff;
  --accent-glow:rgba(91,154,255,.15);
  --purple:#a78bfa;
  --gold:#f59e0b;
  --green:#4ade80;
  --red:#ef4444;
}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',system-ui,-apple-system,sans-serif;min-height:100vh;overflow-x:hidden}
a{color:var(--accent);text-decoration:none}

/* ===== HEADER ===== */
.header{position:sticky;top:0;z-index:100;background:rgba(10,14,26,.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 24px}
.header__inner{max-width:1400px;margin:0 auto;height:64px;display:flex;align-items:center;justify-content:space-between}
.header__logo{display:flex;align-items:center;gap:12px;text-decoration:none}
.header__icon{width:36px;height:36px;background:linear-gradient(135deg,#5b9aff,#a78bfa);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:#fff}
.header__brand{font-size:1.1rem;font-weight:700;color:var(--text);letter-spacing:-.02em}
.header__actions{display:flex;align-items:center;gap:10px}
.btn{padding:9px 18px;border-radius:10px;border:none;font-family:inherit;font-size:.82rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s}
.btn--ghost{background:transparent;color:var(--text-secondary);border:1px solid var(--border)}
.btn--ghost:hover{border-color:var(--border-hover);background:var(--bg-card)}
.btn--primary{background:linear-gradient(135deg,var(--accent),var(--purple));color:#fff;box-shadow:0 4px 16px rgba(91,154,255,.2)}
.btn--primary:hover{box-shadow:0 6px 24px rgba(91,154,255,.35);transform:translateY(-1px)}
.btn--gold{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;box-shadow:0 4px 16px rgba(245,158,11,.2)}
.btn--gold:hover{box-shadow:0 6px 24px rgba(245,158,11,.35);transform:translateY(-1px)}
.btn--unlock{background:linear-gradient(135deg,var(--accent),var(--purple));color:#fff;padding:14px 36px;font-size:1rem;border-radius:12px;box-shadow:0 6px 24px rgba(91,154,255,.3)}
.btn svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}

/* ===== STATS BAR ===== */
.stats-bar{background:var(--bg-surface);border-bottom:1px solid var(--border);padding:20px 24px}
.stats-bar__inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;gap:32px;flex-wrap:wrap}
.stat{display:flex;flex-direction:column;gap:2px}
.stat__value{font-size:1.6rem;font-weight:800;color:var(--text);letter-spacing:-.03em}
.stat__value--accent{color:var(--accent)}
.stat__value--gold{color:var(--gold)}
.stat__label{font-size:.75rem;color:var(--text-muted);font-weight:500;text-transform:uppercase;letter-spacing:.06em}
.stat-divider{width:1px;height:36px;background:var(--border)}
.stats-bar__badge{margin-left:auto;display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--accent-glow);border:1px solid rgba(91,154,255,.2);border-radius:10px}
.stats-bar__badge--free{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.2)}
.stats-bar__badge svg{width:16px;height:16px;stroke:var(--accent);stroke-width:2;fill:none}
.stats-bar__badge--free svg{stroke:var(--gold)}
.stats-bar__badge span{font-size:.8rem;font-weight:600;color:var(--accent)}
.stats-bar__badge--free span{color:var(--gold)}

/* ===== RESULTS GRID ===== */
.results{max-width:1400px;margin:0 auto;padding:28px 24px}
.results__grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}

/* ===== RESULT CARD ===== */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;overflow:hidden;cursor:pointer;transition:all .25s ease;position:relative}
.card:hover{transform:translateY(-6px);border-color:var(--accent);box-shadow:0 12px 40px rgba(91,154,255,.12)}
.card__img-wrap{position:relative;width:100%;aspect-ratio:1;overflow:hidden;background:var(--bg-surface)}
.card__img{width:100%;height:100%;object-fit:cover;transition:filter .5s ease,transform .3s ease}
.card:hover .card__img{transform:scale(1.03)}
.card__source{position:absolute;bottom:0;left:0;right:0;padding:8px 12px;background:linear-gradient(transparent,rgba(0,0,0,.85));font-size:.75rem;color:#fff;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card__body{padding:12px 14px}
.card__score{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.card__pct{font-size:.9rem;font-weight:700;color:var(--accent)}
.card__bar{flex:1;height:4px;background:var(--border);border-radius:4px;margin-left:10px;overflow:hidden}
.card__bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--accent),var(--purple))}
.card__domain{font-size:.78rem;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card__explicit{position:absolute;top:10px;left:10px;background:rgba(239,68,68,.85);color:#fff;font-size:.65rem;font-weight:700;padding:4px 10px;border-radius:8px;z-index:3;letter-spacing:.04em;display:flex;align-items:center;gap:4px}

/* LOCKED STATE */
.card--locked .card__img{filter:blur(10px) saturate(0.6);transform:scale(1.08)}
.card--locked:hover .card__img{filter:blur(8px) saturate(0.7)}
.card--locked .card__body{filter:blur(4px)}
.card--locked .card__lock{display:flex!important}
.card__lock{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.55);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.12);padding:10px 20px;border-radius:12px;align-items:center;gap:8px;color:#fff;font-size:.82rem;font-weight:600;z-index:4;white-space:nowrap}
.card__lock svg{width:18px;height:18px}

/* Tease animation on click */
.card--locked.tease .card__img{filter:blur(2px) saturate(0.9)!important;transition:filter .15s ease}
.card--locked.tease .card__lock{opacity:0;transition:opacity .15s}

/* ===== UPGRADE BANNER ===== */
.upgrade-banner{max-width:1400px;margin:0 auto;padding:0 24px 28px}
.upgrade-banner__inner{background:linear-gradient(135deg,var(--bg-card),#1a1f3a);border:1px solid var(--border);border-radius:20px;padding:32px 40px;display:flex;align-items:center;gap:24px;flex-wrap:wrap}
.upgrade-banner__text{flex:1;min-width:200px}
.upgrade-banner__title{font-size:1.15rem;font-weight:700;margin-bottom:4px}
.upgrade-banner__sub{font-size:.88rem;color:var(--text-muted)}
.upgrade-banner__actions{display:flex;gap:12px;flex-wrap:wrap}
.upgrade-banner__link{font-size:.82rem;color:var(--text-muted);text-decoration:underline;margin-top:12px;display:block;text-align:center}

/* ===== DETAIL MODAL ===== */
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:1000;justify-content:center;align-items:center;padding:20px}
.modal-overlay.active{display:flex}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:24px;max-width:560px;width:100%;max-height:90vh;overflow:hidden;box-shadow:0 32px 80px rgba(0,0,0,.5);animation:modalIn .25s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal__close{position:absolute;top:16px;right:16px;width:36px;height:36px;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.1);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:5;color:#fff;font-size:18px;transition:all .2s}
.modal__close:hover{background:rgba(255,255,255,.15)}
.modal__img-wrap{position:relative;width:100%;aspect-ratio:4/3;overflow:hidden;background:var(--bg-surface)}
.modal__img{width:100%;height:100%;object-fit:cover}
.modal__img--locked{filter:blur(14px) saturate(0.5);transform:scale(1.1);animation:blurPulse 3s ease-in-out infinite}
@keyframes blurPulse{0%,100%{filter:blur(14px) saturate(0.5)}50%{filter:blur(8px) saturate(0.7)}}
.modal__lock-overlay{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:rgba(0,0,0,.35);z-index:2}
.modal__lock-overlay svg{width:44px;height:44px;stroke:#fff;stroke-width:1.5;fill:none;opacity:.85}
.modal__lock-overlay span{color:#fff;font-weight:700;text-shadow:0 2px 8px rgba(0,0,0,.5)}
.modal__body{padding:20px 24px}
.modal__meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.modal__domain{font-size:1rem;font-weight:700;color:var(--text)}
.modal__similarity{font-size:.85rem;font-weight:600;color:var(--accent);background:var(--accent-glow);padding:4px 12px;border-radius:8px}
.modal__actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.modal__action{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg-surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .2s}
.modal__action:hover{border-color:var(--border-hover);background:var(--bg-card-hover)}
.modal__action svg{width:20px;height:20px;stroke:var(--accent);stroke-width:2;fill:none;flex-shrink:0}
.modal__action-text{display:flex;flex-direction:column}
.modal__action-title{font-size:.82rem;font-weight:600;color:var(--text)}
.modal__action-sub{font-size:.7rem;color:var(--text-muted)}
.modal__action--locked{opacity:.4;cursor:not-allowed}
.modal__action--locked:hover{border-color:var(--border);background:var(--bg-surface)}

/* ===== NO RESULTS ===== */
.no-results{text-align:center;padding:80px 24px}
.no-results svg{width:64px;height:64px;stroke:var(--text-muted);stroke-width:1.5;fill:none;margin-bottom:20px}
.no-results h3{font-size:1.2rem;margin-bottom:8px}
.no-results p{color:var(--text-muted);font-size:.9rem}

/* ===== LOADING ===== */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:100px 24px;gap:20px}
.loading__spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  .header{padding:0 16px}
  .stats-bar{padding:16px}
  .stats-bar__inner{gap:16px}
  .stat__value{font-size:1.2rem}
  .stats-bar__badge{margin-left:0;width:100%}
  .results{padding:16px}
  .results__grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
  .card__body{padding:10px 12px}
  .upgrade-banner__inner{padding:24px;flex-direction:column;text-align:center}
  .upgrade-banner__actions{justify-content:center}
  .modal{max-width:95%;border-radius:20px}
  .modal__actions{grid-template-columns:1fr}
}

@media(max-width:480px){
  .results__grid{grid-template-columns:repeat(2,1fr);gap:10px}
  .header__actions .btn span{display:none}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header__inner">
    <a href="/" class="header__logo">
      <div class="header__icon">P</div>
      <span class="header__brand">Protevio AI</span>
    </a>
    <div class="header__actions">
      <button class="btn btn--gold" id="shareBtn" style="display:none">
        <svg viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        <span>Share</span>
      </button>
      <button class="btn btn--primary" id="pdfBtn" style="display:none">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span>PDF Report</span>
      </button>
      <a href="/" class="btn btn--ghost">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <span>New Search</span>
      </a>
    </div>
  </div>
</header>

<!-- STATS BAR -->
<div class="stats-bar" id="statsBar">
  <div class="stats-bar__inner">
    <div class="stat">
      <div class="stat__value stat__value--accent" id="statMatches">—</div>
      <div class="stat__label">Matches Found</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat">
      <div class="stat__value" id="statDomains">—</div>
      <div class="stat__label">Websites</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat">
      <div class="stat__value" id="statTime">—</div>
      <div class="stat__label">Search Time</div>
    </div>
    <div id="planBadge" class="stats-bar__badge stats-bar__badge--free">
      <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      <span>Free Preview</span>
    </div>
  </div>
</div>

<!-- UPGRADE BANNER (free users) -->
<div class="upgrade-banner" id="upgradeBanner" style="display:none">
  <div class="upgrade-banner__inner">
    <svg viewBox="0 0 24 24" style="width:44px;height:44px;stroke:var(--accent);stroke-width:1.5;fill:none;flex-shrink:0"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
    <div class="upgrade-banner__text">
      <div class="upgrade-banner__title">Unlock full access to your results</div>
      <div class="upgrade-banner__sub">See source URLs, high-resolution images, domain names, and download a PDF evidence report.</div>
    </div>
    <div class="upgrade-banner__actions">
      <button class="btn btn--unlock" id="unlockBtn">Unlock Results — €9.99</button>
    </div>
    <a href="/pricing" class="upgrade-banner__link">Or subscribe for unlimited access →</a>
  </div>
</div>

<!-- RESULTS GRID -->
<main class="results" id="resultsContainer">
  <div class="loading" id="loadingState">
    <div class="loading__spinner"></div>
    <div style="font-size:.9rem;color:var(--text-muted)">Loading results...</div>
  </div>
  <div class="results__grid" id="resultsGrid" style="display:none"></div>
  <div class="no-results" id="noResults" style="display:none">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 15s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
    <h3>No Matches Found</h3>
    <p>We didn't find any matching faces in our database. Try uploading a clearer photo.</p>
    <a href="/" class="btn btn--primary" style="margin-top:20px;display:inline-flex">Try Another Search</a>
  </div>
</main>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal__close" id="modalClose">✕</div>
    <div class="modal__img-wrap">
      <img class="modal__img" id="modalImg" src="" alt="Match">
      <div class="modal__lock-overlay" id="modalLockOverlay" style="display:none">
        <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
        <span style="font-size:.95rem">Unlock to reveal</span>
        <span style="font-size:.8rem;opacity:.7" id="modalLockPct"></span>
      </div>
    </div>
    <div class="modal__body">
      <div class="modal__meta">
        <div class="modal__domain" id="modalDomain">—</div>
        <div class="modal__similarity" id="modalSimilarity">—%</div>
      </div>
      <div class="modal__actions" id="modalActions">
        <div class="modal__action" id="actionVisit">
          <svg viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          <div class="modal__action-text"><span class="modal__action-title">Visit Website</span><span class="modal__action-sub">Open source page</span></div>
        </div>
        <div class="modal__action" id="actionImage">
          <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          <div class="modal__action-text"><span class="modal__action-title">View Image</span><span class="modal__action-sub">Full resolution</span></div>
        </div>
        <div class="modal__action" id="actionCopy">
          <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          <div class="modal__action-text"><span class="modal__action-title">Copy ID</span><span class="modal__action-sub">Reference number</span></div>
        </div>
        <div class="modal__action" id="actionTakedown">
          <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          <div class="modal__action-text"><span class="modal__action-title">Request Takedown</span><span class="modal__action-sub">File removal request</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API = 'https://api.protevio.com/api';

function encImg(filename) {
  if(!filename) return '';
  const b64 = btoa(filename).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  return API + '/img/' + b64;
}
function getToken() { return localStorage.getItem('protevio_token'); }

// ===== LOAD RESULTS =====
let results = [];
let searchId = '';
let userPlan = 'free';
let isUnlocked = false;
let isFree = true;

(function init() {
  // Get results from sessionStorage
  const raw = sessionStorage.getItem('protevio_results');
  if(!raw) {
    // No results — redirect back to search
    window.location.href = '/';
    return;
  }

  try {
    const data = JSON.parse(raw);
    
    // Check freshness (max 30 min)
    if(Date.now() - data.timestamp > 30 * 60 * 1000) {
      sessionStorage.removeItem('protevio_results');
      window.location.href = '/';
      return;
    }

    results = data.results || [];
    searchId = data.search_id || '';
    userPlan = data.userPlan || 'free';
    isUnlocked = data.isUnlocked || false;
    isFree = (userPlan === 'free') && !isUnlocked;

  } catch(e) {
    window.location.href = '/';
    return;
  }

  renderResults();
})();

function renderResults() {
  const loading = document.getElementById('loadingState');
  const grid = document.getElementById('resultsGrid');
  const noRes = document.getElementById('noResults');

  loading.style.display = 'none';

  if(!results.length) {
    noRes.style.display = 'block';
    return;
  }

  grid.style.display = 'grid';

  // Stats
  const domains = new Set(results.map(r => r.domain).filter(Boolean));
  const searchTime = ((Math.random() * 1.5) + 0.8).toFixed(2);
  
  document.getElementById('statMatches').textContent = results.length;
  document.getElementById('statDomains').textContent = domains.size;
  document.getElementById('statTime').textContent = searchTime + 's';

  // Plan badge
  const badge = document.getElementById('planBadge');
  if(!isFree) {
    badge.classList.remove('stats-bar__badge--free');
    badge.innerHTML = '<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>Full Access</span>';
    badge.querySelector('svg').style.stroke = 'var(--green)';
    badge.querySelector('span').style.color = 'var(--green)';
  }

  // Show action buttons
  if(!isFree) {
    document.getElementById('pdfBtn').style.display = 'flex';
  }
  if(results.length > 0) {
    document.getElementById('shareBtn').style.display = 'flex';
  }

  // Upgrade banner
  if(isFree) {
    document.getElementById('upgradeBanner').style.display = 'block';
  }

  // Render cards
  results.forEach((match, i) => {
    const card = document.createElement('div');
    card.className = 'card' + (isFree ? ' card--locked' : '');
    
    const similarity = Math.round(match.similarity || 0);
    const domain = match.domain || '';
    const imgUrl = encImg(match.filename || '');
    const isExplicit = match.nsfw || (match.category && match.category !== 'safe');

    card.innerHTML = 
      '<div class="card__img-wrap">' +
        '<img class="card__img" src="' + imgUrl + '" alt="Match" loading="lazy" onerror="this.src=\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23161d2f%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%236b7280%22 font-size=%2210%22>No image</text></svg>\'">' +
        (isExplicit ? '<div class="card__explicit"><span style="background:rgba(255,255,255,.25);padding:1px 5px;border-radius:3px;font-weight:800">E</span> EXPLICIT</div>' : '') +
        '<div class="card__lock"><svg viewBox="0 0 24 24" style="stroke:currentColor;stroke-width:2;fill:none"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>Tap to preview</div>' +
        '<div class="card__source">' + (isFree ? '••••••.com' : domain) + '</div>' +
      '</div>' +
      '<div class="card__body">' +
        '<div class="card__score">' +
          '<span class="card__pct">' + similarity + '%</span>' +
          '<div class="card__bar"><div class="card__bar-fill" style="width:' + similarity + '%"></div></div>' +
        '</div>' +
        '<div class="card__domain">' + (isFree ? '••••••.com' : domain) + '</div>' +
      '</div>';

    card.addEventListener('click', () => {
      if(isFree) {
        card.classList.add('tease');
        setTimeout(() => { card.classList.remove('tease'); openModal(match); }, 400);
      } else {
        openModal(match);
      }
    });

    // Staggered entrance animation
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    card.style.transition = 'opacity .4s ease, transform .4s ease';
    setTimeout(() => {
      card.style.opacity = '1';
      card.style.transform = 'translateY(0)';
    }, 50 + i * 30);

    grid.appendChild(card);
  });
}

// ===== MODAL =====
function openModal(match) {
  const overlay = document.getElementById('modalOverlay');
  const imgUrl = encImg(match.filename || '');
  const similarity = Math.round(match.similarity || 0);
  const domain = match.domain || 'Unknown source';

  document.getElementById('modalImg').src = imgUrl;
  document.getElementById('modalImg').className = 'modal__img' + (isFree ? ' modal__img--locked' : '');
  document.getElementById('modalDomain').textContent = isFree ? '••••••.com' : domain;
  document.getElementById('modalSimilarity').textContent = similarity + '% match';
  
  const lockOverlay = document.getElementById('modalLockOverlay');
  lockOverlay.style.display = isFree ? 'flex' : 'none';
  document.getElementById('modalLockPct').textContent = similarity + '% match found';

  // Action handlers
  const actions = document.querySelectorAll('.modal__action');
  actions.forEach(a => {
    if(isFree) {
      a.classList.add('modal__action--locked');
    } else {
      a.classList.remove('modal__action--locked');
    }
  });

  document.getElementById('actionVisit').onclick = () => {
    if(isFree) { alert('Unlock results to access source websites.'); return; }
    const url = match.page_url || match.url;
    if(url) window.open(url, '_blank');
  };
  document.getElementById('actionImage').onclick = () => {
    if(isFree) { alert('Unlock results to view full images.'); return; }
    if(match.url) window.open(match.url, '_blank');
  };
  document.getElementById('actionCopy').onclick = () => {
    navigator.clipboard.writeText(match.id || '').then(() => {
      const title = document.querySelector('#actionCopy .modal__action-title');
      title.textContent = 'Copied!';
      setTimeout(() => title.textContent = 'Copy ID', 1500);
    });
  };
  document.getElementById('actionTakedown').onclick = () => {
    if(isFree) { alert('Unlock results to file takedown requests.'); return; }
    alert('Takedown request submitted for ' + domain + '.\n\nContact support@protevio.com for assistance.');
  };

  overlay.classList.add('active');
}

// Close modal
document.getElementById('modalClose').addEventListener('click', () => {
  document.getElementById('modalOverlay').classList.remove('active');
});
document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if(e.target === e.currentTarget) {
    e.currentTarget.classList.remove('active');
  }
});
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape') document.getElementById('modalOverlay').classList.remove('active');
});

// ===== UNLOCK =====
document.getElementById('unlockBtn').addEventListener('click', async () => {
  const token = getToken();
  if(!token) { window.location.href = '/login'; return; }

  // Save results for restore after payment
  localStorage.setItem('protevio_pending_unlock', JSON.stringify({
    search_id: searchId,
    results: results
  }));

  const btn = document.getElementById('unlockBtn');
  btn.textContent = 'Redirecting to payment...';
  btn.disabled = true;

  try {
    const res = await fetch(API + '/checkout-single', {
      method: 'POST',
      headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
      body: JSON.stringify({search_id: searchId})
    });
    const data = await res.json();
    if(data.url) {
      window.location.href = data.url;
    } else {
      alert(data.error || 'Payment setup failed');
      btn.textContent = 'Unlock Results — €9.99';
      btn.disabled = false;
    }
  } catch(e) {
    alert('Connection error. Please try again.');
    btn.textContent = 'Unlock Results — €9.99';
    btn.disabled = false;
  }
});

// ===== PDF REPORT =====
document.getElementById('pdfBtn').addEventListener('click', async () => {
  const btn = document.getElementById('pdfBtn');
  const origHTML = btn.innerHTML;
  btn.innerHTML = '<div class="loading__spinner" style="width:16px;height:16px;border-width:2px"></div> <span>Generating...</span>';
  btn.disabled = true;

  try {
    const token = getToken();
    const resp = await fetch(API + '/generate-report', {
      method: 'POST',
      headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
      body: JSON.stringify({
        results: results,
        search_id: searchId,
        search_date: new Date().toISOString().replace('T', ' ').slice(0, 19) + ' UTC',
        email: (JSON.parse(localStorage.getItem('protevio_user') || '{}')).email || ''
      })
    });
    if(!resp.ok) throw new Error('Failed');
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'protevio_evidence_report_' + new Date().toISOString().slice(0,10) + '.pdf';
    a.click();
    URL.revokeObjectURL(url);
  } catch(e) {
    alert('Failed to generate report. Please try again.');
  }
  btn.innerHTML = origHTML;
  btn.disabled = false;
});

// ===== SHARE =====
document.getElementById('shareBtn').addEventListener('click', async () => {
  const btn = document.getElementById('shareBtn');
  const origHTML = btn.innerHTML;
  const domains = new Set(results.map(r => r.domain).filter(Boolean));
  const shareText = 'I just found ' + results.length + ' photos of myself on ' + domains.size + ' websites I never knew about.\n\nCheck where YOUR face appears online →';
  const shareUrl = 'https://protevio.com';

  if(navigator.share) {
    try {
      const token = getToken();
      if(token && searchId) {
        btn.innerHTML = '<div class="loading__spinner" style="width:16px;height:16px;border-width:2px"></div> <span>Preparing...</span>';
        const imgResp = await fetch(API + '/share/preview/' + searchId, {
          headers: {'Authorization': 'Bearer ' + token}
        });
        if(imgResp.ok) {
          const blob = await imgResp.blob();
          const file = new File([blob], 'protevio_results.png', {type: 'image/png'});
          await navigator.share({ text: shareText + '\n' + shareUrl, files: [file] });
          btn.innerHTML = origHTML;
          return;
        }
      }
      await navigator.share({ text: shareText, url: shareUrl });
      btn.innerHTML = origHTML;
      return;
    } catch(e) {
      if(e.name === 'AbortError') { btn.innerHTML = origHTML; return; }
    }
  }

  // Desktop: download image + copy text
  const token = getToken();
  if(token && searchId) {
    btn.innerHTML = '<div class="loading__spinner" style="width:16px;height:16px;border-width:2px"></div> <span>Generating...</span>';
    try {
      const imgResp = await fetch(API + '/share/preview/' + searchId, {
        headers: {'Authorization': 'Bearer ' + token}
      });
      if(imgResp.ok) {
        const blob = await imgResp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'protevio_results.png';
        a.click();
        URL.revokeObjectURL(url);
      }
    } catch(e) {}
  }

  try {
    await navigator.clipboard.writeText(shareText + '\n' + shareUrl);
    btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> <span>Copied!</span>';
    setTimeout(() => { btn.innerHTML = origHTML; }, 2000);
  } catch(e) {
    btn.innerHTML = origHTML;
  }
});

// ===== CHECK UNLOCK ON RETURN =====
(function checkUnlockReturn() {
  const params = new URLSearchParams(window.location.search);
  const unlockedId = params.get('unlocked');
  if(unlockedId) {
    isUnlocked = true;
    isFree = false;
    window.history.replaceState({}, '', window.location.pathname);
    
    try {
      const saved = JSON.parse(localStorage.getItem('protevio_pending_unlock') || 'null');
      if(saved && saved.results) {
        localStorage.removeItem('protevio_pending_unlock');
        results = saved.results;
        searchId = saved.search_id || '';
        
        // Update sessionStorage
        sessionStorage.setItem('protevio_results', JSON.stringify({
          results, search_id: searchId, count: results.length,
          userPlan, isUnlocked: true, timestamp: Date.now()
        }));
        
        // Re-render
        document.getElementById('resultsGrid').innerHTML = '';
        document.getElementById('upgradeBanner').style.display = 'none';
        renderResults();
      }
    } catch(e) {}
  }

  if(params.get('unlock_cancelled')) {
    window.history.replaceState({}, '', window.location.pathname);
    localStorage.removeItem('protevio_pending_unlock');
  }
})();
</script>
</body>
</html>
