<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Minor Protection — Protevio Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:#0c0f1a;color:#e2e8f0;min-height:100vh}
a{color:#5b9aff;text-decoration:none}

/* Header */
.header{background:#141825;border-bottom:1px solid #1e2538;padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.header__title{font-size:1.1rem;font-weight:800;color:#f1f5f9;display:flex;align-items:center;gap:10px}
.header__title svg{width:22px;height:22px;stroke:#ef4444;stroke-width:2;fill:none}
.header__back{font-size:.82rem;color:#6b7280;padding:7px 16px;border:1px solid #2a3349;border-radius:8px;background:none;cursor:pointer;font-family:inherit;transition:all .15s}
.header__back:hover{border-color:#5b9aff;color:#5b9aff}

/* Tabs */
.tabs{display:flex;gap:0;padding:0 32px;background:#141825;border-bottom:1px solid #1e2538}
.tab{padding:14px 24px;font-size:.85rem;font-weight:700;color:#6b7280;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;position:relative;font-family:inherit;background:none;border-top:none;border-left:none;border-right:none}
.tab:hover{color:#e2e8f0}
.tab.active{color:#5b9aff;border-bottom-color:#5b9aff}
.tab .badge{background:#dc2626;color:#fff;font-size:.65rem;font-weight:800;padding:2px 7px;border-radius:10px;margin-left:8px;min-width:18px;text-align:center}
.tab .badge--warn{background:#f59e0b}
.tab-content{display:none}
.tab-content.active{display:block}

/* Stats bar */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;padding:24px 32px 0}
.stat{background:#141825;border:1px solid #1e2538;border-radius:12px;padding:16px}
.stat__label{font-size:.72rem;color:#6b7280;text-transform:uppercase;letter-spacing:.06em;font-weight:700;margin-bottom:6px}
.stat__val{font-size:1.6rem;font-weight:800;color:#f1f5f9}
.stat--danger .stat__val{color:#ef4444}
.stat--warn .stat__val{color:#f59e0b}

/* Controls */
.controls{padding:20px 32px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.controls select,.controls input{background:#141825;border:1px solid #2a3349;color:#e2e8f0;padding:8px 14px;border-radius:8px;font-family:inherit;font-size:.85rem}
.controls select:focus,.controls input:focus{outline:none;border-color:#5b9aff}
.btn{padding:8px 18px;border-radius:8px;font-family:inherit;font-size:.82rem;font-weight:700;cursor:pointer;border:none;transition:all .15s}
.btn--primary{background:#2563eb;color:#fff}.btn--primary:hover{background:#1d4ed8}
.btn--danger{background:#dc2626;color:#fff}.btn--danger:hover{background:#b91c1c}
.btn--success{background:#16a34a;color:#fff}.btn--success:hover{background:#15803d}
.btn--outline{background:none;border:1px solid #2a3349;color:#9ca3af}.btn--outline:hover{border-color:#5b9aff;color:#5b9aff}
.btn:disabled{opacity:.4;cursor:not-allowed}
.selected-count{font-size:.85rem;color:#9ca3af;margin-left:auto}

/* Grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;padding:12px 32px 32px}
.face-card{background:#141825;border:1px solid #1e2538;border-radius:12px;overflow:hidden;position:relative;transition:all .15s;cursor:pointer}
.face-card:hover{border-color:#3a4a60}
.face-card.selected{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.3)}
.face-card__check{position:absolute;top:8px;left:8px;width:22px;height:22px;border-radius:6px;border:2px solid #3a4a60;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:2;transition:all .15s}
.face-card.selected .face-card__check{border-color:#2563eb;background:#2563eb}
.face-card.selected .face-card__check::after{content:'✓';color:#fff;font-size:12px;font-weight:700}
.face-card__age{position:absolute;top:8px;right:8px;background:rgba(220,38,38,.85);color:#fff;font-size:.66rem;font-weight:800;padding:3px 8px;border-radius:5px;z-index:2}
.face-card__img{width:100%;aspect-ratio:1;object-fit:cover;background:#1a1f2e;display:block}
.face-card__info{padding:10px 12px}
.face-card__domain{font-size:.75rem;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.face-card__meta{font-size:.7rem;color:#4b5563;margin-top:3px}

/* Violations table */
.vtable{width:100%;border-collapse:collapse;margin:0 0 32px}
.vtable th{text-align:left;font-size:.72rem;color:#6b7280;text-transform:uppercase;letter-spacing:.05em;font-weight:700;padding:12px 16px;border-bottom:1px solid #1e2538;background:#0f1220;position:sticky;top:0}
.vtable td{padding:12px 16px;border-bottom:1px solid #1a1f30;font-size:.85rem;vertical-align:middle}
.vtable tr:hover td{background:#141825}
.vtable__thumb{width:44px;height:44px;border-radius:8px;object-fit:cover;background:#1a1f2e;border:1px solid #2a3349}
.vtable__user{font-weight:700;color:#f1f5f9}
.vtable__email{font-size:.75rem;color:#6b7280}
.vtable__time{font-size:.78rem;color:#6b7280}
.vtable__ip{font-size:.75rem;color:#4b5563;font-family:monospace}
.vtable__age-badge{display:inline-block;padding:2px 8px;border-radius:5px;font-size:.72rem;font-weight:800}
.vtable__age-badge--danger{background:rgba(220,38,38,.2);color:#fca5a5}
.vtable__age-badge--warn{background:rgba(245,158,11,.15);color:#fcd34d}

/* Flagged users */
.user-card{background:#141825;border:1px solid #1e2538;border-radius:12px;padding:20px;display:flex;align-items:center;gap:16px;transition:all .15s}
.user-card:hover{border-color:#3a4a60}
.user-card__info{flex:1;min-width:0}
.user-card__name{font-weight:800;color:#f1f5f9;font-size:.95rem}
.user-card__email{font-size:.78rem;color:#6b7280;margin-top:2px}
.user-card__meta{font-size:.75rem;color:#4b5563;margin-top:4px}
.user-card__warnings{font-size:1.4rem;font-weight:800;color:#ef4444;min-width:50px;text-align:center}
.user-card__plan{font-size:.72rem;padding:3px 10px;border-radius:5px;font-weight:700}
.user-card__plan--suspended{background:rgba(220,38,38,.2);color:#fca5a5}
.user-card__plan--free{background:rgba(59,130,246,.15);color:#93c5fd}
.user-card__plan--active{background:rgba(22,163,74,.15);color:#86efac}
.user-list{display:grid;gap:12px;padding:12px 32px 32px}

/* Pagination */
.pagination{display:flex;align-items:center;justify-content:center;gap:8px;padding:16px 32px 40px}
.page-btn{padding:7px 14px;border-radius:6px;font-size:.82rem;font-weight:600;cursor:pointer;border:1px solid #2a3349;background:none;color:#9ca3af;font-family:inherit}
.page-btn:hover{border-color:#5b9aff;color:#5b9aff}
.page-btn.active{background:#2563eb;border-color:#2563eb;color:#fff}
.page-btn:disabled{opacity:.3;cursor:not-allowed}

/* Loading / Empty */
.loading{text-align:center;padding:80px;color:#6b7280;font-size:.9rem}
.spinner{width:32px;height:32px;border:3px solid #1e293b;border-top-color:#5b9aff;border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 32px;color:#4b5563}
.empty svg{width:48px;height:48px;stroke:#2a3349;margin-bottom:12px}
.empty__text{font-size:.9rem;color:#6b7280}

/* Confirm modal */
.confirm-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:1000;justify-content:center;align-items:center}
.confirm-bg.open{display:flex}
.confirm{background:#141825;border:1px solid #2a3349;border-radius:16px;max-width:460px;width:90%;padding:28px}
.confirm__title{font-size:1.1rem;font-weight:800;color:#fca5a5;margin-bottom:8px}
.confirm__text{font-size:.88rem;color:#9ca3af;line-height:1.6;margin-bottom:20px}
.confirm__text strong{color:#ef4444}
.confirm__actions{display:flex;gap:10px;justify-content:flex-end}

/* Bulk delete section */
.bulk-section{padding:0 32px 24px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.bulk-section__label{font-size:.85rem;color:#9ca3af}

@media(max-width:600px){
  .stats{padding:16px 16px 0;grid-template-columns:repeat(2,1fr)}
  .controls{padding:16px}
  .grid{padding:8px 16px 32px;grid-template-columns:repeat(2,1fr);gap:8px}
  .header{padding:14px 16px}
  .tabs{padding:0 16px;overflow-x:auto}
  .tab{padding:12px 16px;white-space:nowrap}
  .vtable{font-size:.78rem}
  .vtable td,.vtable th{padding:8px 10px}
  .user-list{padding:8px 16px 32px}
  .bulk-section{padding:0 16px 16px}
}
</style>
</head>
<body>

<div class="header">
  <div class="header__title">
    <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
    Minor Protection
  </div>
  <button class="header__back" onclick="window.location.href='/ctrl-7beee6dc.html'">← Back to Dashboard</button>
</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab active" data-tab="faces" onclick="switchTab('faces')">
    DB Faces Review <span class="badge" id="badgeFaces" style="display:none">0</span>
  </button>
  <button class="tab" data-tab="violations" onclick="switchTab('violations')">
    Violations Log <span class="badge badge--warn" id="badgeViolations" style="display:none">0</span>
  </button>
  <button class="tab" data-tab="users" onclick="switchTab('users')">
    Flagged Users <span class="badge" id="badgeUsers" style="display:none">0</span>
  </button>
</div>

<!-- ===== TAB 1: FACE REVIEW ===== -->
<div class="tab-content active" id="tab-faces">

  <div class="stats" id="statsBar">
    <div class="loading"><div class="spinner"></div>Loading stats...</div>
  </div>

  <div class="controls" id="controls" style="display:none">
    <label style="font-size:.82rem;color:#9ca3af">Max age:</label>
    <select id="ageFilter" onchange="loadFaces()">
      <option value="13">Under 13</option>
      <option value="16">Under 16</option>
      <option value="18" selected>Under 18</option>
    </select>
    <button class="btn btn--outline" onclick="selectAll()">Select All</button>
    <button class="btn btn--outline" onclick="deselectAll()">Deselect All</button>
    <button class="btn btn--danger" id="deleteBtn" disabled onclick="confirmDelete()">Delete Selected (0)</button>
    <span class="selected-count" id="selectedCount"></span>
  </div>

  <div class="grid" id="faceGrid">
    <div class="loading"><div class="spinner"></div>Loading faces...</div>
  </div>

  <div class="pagination" id="pagination" style="display:none"></div>

  <!-- Bulk delete -->
  <div class="bulk-section" id="bulkSection" style="display:none">
    <span class="bulk-section__label">Bulk action:</span>
    <select id="bulkAge" style="background:#141825;border:1px solid #2a3349;color:#e2e8f0;padding:8px 14px;border-radius:8px;font-family:inherit;font-size:.85rem">
      <option value="10">Delete all under 10</option>
      <option value="13">Delete all under 13</option>
      <option value="16">Delete all under 16</option>
    </select>
    <button class="btn btn--danger" onclick="confirmBulkDelete()">Bulk Delete...</button>
  </div>
</div>

<!-- ===== TAB 2: VIOLATIONS LOG ===== -->
<div class="tab-content" id="tab-violations">
  <div style="padding:24px 32px 0">
    <p style="font-size:.85rem;color:#6b7280;margin-bottom:16px">Search attempts that were blocked because the uploaded face was estimated as a minor. Each entry includes the face thumbnail the user tried to search with.</p>
  </div>
  <div style="overflow-x:auto;padding:0 32px">
    <table class="vtable" id="violationsTable">
      <thead>
        <tr>
          <th>Face</th>
          <th>User</th>
          <th>Est. Age</th>
          <th>IP Address</th>
          <th>Time</th>
          <th>Warnings</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="violationsBody">
        <tr><td colspan="7"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ===== TAB 3: FLAGGED USERS ===== -->
<div class="tab-content" id="tab-users">
  <div style="padding:24px 32px 0">
    <p style="font-size:.85rem;color:#6b7280;margin-bottom:16px">Users who have triggered minor detection warnings. Users are auto-suspended after 3 warnings.</p>
  </div>
  <div class="user-list" id="userList">
    <div class="loading"><div class="spinner"></div>Loading flagged users...</div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="confirm-bg" id="confirmBg" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="confirm">
    <div class="confirm__title" id="confirmTitle">Confirm Action</div>
    <div class="confirm__text" id="confirmText"></div>
    <div class="confirm__actions">
      <button class="btn btn--outline" onclick="document.getElementById('confirmBg').classList.remove('open')">Cancel</button>
      <button class="btn btn--danger" id="confirmBtn">Confirm</button>
    </div>
  </div>
</div>

<script>
const API = 'https://api.protevio.com/api';
const token = localStorage.getItem('protevio_token');
if(!token) window.location.href = '/login.html';

let currentPage = 1;
let selectedIds = new Set();
let allFaces = [];

async function apiFetch(url, opts) {
  const res = await fetch(API + url, {
    ...opts,
    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json', ...(opts?.headers || {}) }
  });
  if(res.status === 403) { alert('Admin access required'); return null; }
  return res.ok ? await res.json() : null;
}

// ===== TAB SWITCHING =====
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
  
  if(tab === 'violations') loadViolations();
  if(tab === 'users') loadFlaggedUsers();
}

// ===== TAB 1: STATS =====
async function loadStats() {
  const data = await apiFetch('/admin/minor-faces/stats');
  if(!data) return;
  
  const minorTotal = data.minor_total || 0;
  const badge = document.getElementById('badgeFaces');
  if(minorTotal > 0) { badge.textContent = minorTotal.toLocaleString(); badge.style.display = 'inline'; }
  
  document.getElementById('statsBar').innerHTML = `
    <div class="stat stat--danger"><div class="stat__label">Under 13</div><div class="stat__val">${(data.under_13||0).toLocaleString()}</div></div>
    <div class="stat stat--danger"><div class="stat__label">Age 13–15</div><div class="stat__val">${(data.age_13_15||0).toLocaleString()}</div></div>
    <div class="stat stat--warn"><div class="stat__label">Age 16–17</div><div class="stat__val">${(data.age_16_17||0).toLocaleString()}</div></div>
    <div class="stat"><div class="stat__label">Total Minors</div><div class="stat__val">${minorTotal.toLocaleString()}</div></div>
    <div class="stat"><div class="stat__label">Adults (18+)</div><div class="stat__val">${(data.adult||0).toLocaleString()}</div></div>
    <div class="stat"><div class="stat__label">Total Faces</div><div class="stat__val">${(data.total||0).toLocaleString()}</div></div>
  `;
}

// ===== TAB 1: FACE GRID =====
async function loadFaces(page) {
  currentPage = page || 1;
  selectedIds.clear();
  updateDeleteBtn();
  const maxAge = document.getElementById('ageFilter').value;
  const grid = document.getElementById('faceGrid');
  grid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading faces...</div>';

  const data = await apiFetch(`/admin/minor-faces?page=${currentPage}&per_page=60&max_age=${maxAge}`);
  if(!data) return;

  allFaces = data.faces;
  document.getElementById('controls').style.display = 'flex';
  document.getElementById('bulkSection').style.display = 'flex';
  document.getElementById('selectedCount').textContent = `${data.total.toLocaleString()} faces total · Page ${data.page} of ${data.total_pages}`;

  if(!allFaces.length) {
    grid.innerHTML = '<div class="loading" style="grid-column:1/-1"><svg viewBox="0 0 24 24" style="width:48px;height:48px;stroke:#2a3349;fill:none;margin-bottom:12px"><circle cx="12" cy="12" r="10"/><path d="M8 15s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg><br><span style="color:#6b7280">No faces found matching this filter.</span></div>';
    document.getElementById('pagination').style.display = 'none';
    return;
  }

  grid.innerHTML = '';
  allFaces.forEach(f => {
    const card = document.createElement('div');
    card.className = 'face-card';
    card.dataset.id = f.face_id;
    const imgUrl = API + '/img/' + btoa(f.filename).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    card.innerHTML = `
      <div class="face-card__check"></div>
      <div class="face-card__age">Age ~${f.age}</div>
      <img class="face-card__img" src="${imgUrl}" alt="Face" loading="lazy"
        onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%231a1f2e%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%234b5563%22 font-size=%2210%22>No img</text></svg>'">
      <div class="face-card__info">
        <div class="face-card__domain">${f.domain || 'Unknown'}</div>
        <div class="face-card__meta">${f.gender === 'M' ? 'Male' : f.gender === 'F' ? 'Female' : f.gender || ''} · ${f.created_at ? f.created_at.slice(0,10) : ''}</div>
      </div>`;
    card.addEventListener('click', () => toggleSelect(card, f.face_id));
    grid.appendChild(card);
  });

  buildPagination(data.page, data.total_pages);
}

function toggleSelect(card, id) {
  if(selectedIds.has(id)) { selectedIds.delete(id); card.classList.remove('selected'); }
  else { selectedIds.add(id); card.classList.add('selected'); }
  updateDeleteBtn();
}
function selectAll() {
  allFaces.forEach(f => selectedIds.add(f.face_id));
  document.querySelectorAll('.face-card').forEach(c => c.classList.add('selected'));
  updateDeleteBtn();
}
function deselectAll() {
  selectedIds.clear();
  document.querySelectorAll('.face-card').forEach(c => c.classList.remove('selected'));
  updateDeleteBtn();
}
function updateDeleteBtn() {
  const btn = document.getElementById('deleteBtn');
  btn.disabled = selectedIds.size === 0;
  btn.textContent = `Delete Selected (${selectedIds.size})`;
}

function buildPagination(current, total) {
  const el = document.getElementById('pagination');
  if(total <= 1) { el.style.display = 'none'; return; }
  el.style.display = 'flex';
  let html = `<button class="page-btn" ${current<=1?'disabled':''} onclick="loadFaces(${current-1})">← Prev</button>`;
  const start = Math.max(1, current - 3), end = Math.min(total, current + 3);
  if(start > 1) html += `<button class="page-btn" onclick="loadFaces(1)">1</button>`;
  if(start > 2) html += `<span style="color:#4b5563">…</span>`;
  for(let i = start; i <= end; i++) html += `<button class="page-btn ${i===current?'active':''}" onclick="loadFaces(${i})">${i}</button>`;
  if(end < total-1) html += `<span style="color:#4b5563">…</span>`;
  if(end < total) html += `<button class="page-btn" onclick="loadFaces(${total})">${total}</button>`;
  html += `<button class="page-btn" ${current>=total?'disabled':''} onclick="loadFaces(${current+1})">Next →</button>`;
  el.innerHTML = html;
}

// ===== TAB 1: DELETE =====
function confirmDelete() {
  const n = selectedIds.size;
  if(!n) return;
  document.getElementById('confirmTitle').textContent = 'Confirm Deletion';
  document.getElementById('confirmText').innerHTML = `You are about to permanently delete <strong>${n} face${n>1?'s':''}</strong> from the database. This cannot be undone.`;
  document.getElementById('confirmBtn').textContent = 'Delete';
  document.getElementById('confirmBtn').className = 'btn btn--danger';
  document.getElementById('confirmBtn').onclick = doDelete;
  document.getElementById('confirmBg').classList.add('open');
}

async function doDelete() {
  const btn = document.getElementById('confirmBtn');
  btn.textContent = 'Deleting...'; btn.disabled = true;
  try {
    const data = await apiFetch('/admin/minor-faces/delete', {
      method: 'POST', body: JSON.stringify({ face_ids: Array.from(selectedIds) })
    });
    if(data?.success) {
      document.getElementById('confirmBg').classList.remove('open');
      loadStats(); loadFaces(currentPage);
    } else { alert(data?.error || 'Delete failed'); }
  } catch(e) { alert('Connection error'); }
  btn.textContent = 'Delete'; btn.disabled = false;
}

// ===== TAB 1: BULK DELETE =====
async function confirmBulkDelete() {
  const maxAge = parseInt(document.getElementById('bulkAge').value);
  // Dry run first
  const data = await apiFetch('/admin/minor-faces/bulk-delete', {
    method: 'POST', body: JSON.stringify({ max_age: maxAge, confirm: false })
  });
  if(!data) return;

  document.getElementById('confirmTitle').textContent = 'Bulk Delete — Are You Sure?';
  document.getElementById('confirmText').innerHTML = `This will permanently delete <strong>${data.would_delete.toLocaleString()} faces</strong> with estimated age under ${maxAge}. This cannot be undone.`;
  document.getElementById('confirmBtn').textContent = `Delete ${data.would_delete.toLocaleString()} Faces`;
  document.getElementById('confirmBtn').className = 'btn btn--danger';
  document.getElementById('confirmBtn').onclick = async () => {
    const btn = document.getElementById('confirmBtn');
    btn.textContent = 'Deleting...'; btn.disabled = true;
    const result = await apiFetch('/admin/minor-faces/bulk-delete', {
      method: 'POST', body: JSON.stringify({ max_age: maxAge, confirm: true })
    });
    if(result?.success) {
      document.getElementById('confirmBg').classList.remove('open');
      loadStats(); loadFaces(currentPage);
    } else { alert('Bulk delete failed'); }
    btn.disabled = false;
  };
  document.getElementById('confirmBg').classList.add('open');
}


// ===== TAB 2: VIOLATIONS LOG =====
async function loadViolations() {
  const body = document.getElementById('violationsBody');
  body.innerHTML = '<tr><td colspan="7"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>';

  const data = await apiFetch('/admin/warnings?limit=200');
  if(!data) return;

  const badge = document.getElementById('badgeViolations');
  if(data.count > 0) { badge.textContent = data.count; badge.style.display = 'inline'; }

  if(!data.warnings.length) {
    body.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:60px;color:#4b5563">No violations recorded yet.</td></tr>';
    return;
  }

  body.innerHTML = '';
  data.warnings.forEach(w => {
    const tr = document.createElement('tr');
    const ageBadge = w.estimated_age < 13 ? 'danger' : 'warn';
    const thumbSrc = w.face_thumbnail || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 44 44%22><rect fill=%22%231a1f2e%22 width=%2244%22 height=%2244%22/></svg>';
    const planLabel = w.plan === 'suspended' ? '<span style="color:#fca5a5;font-weight:700">Suspended</span>' : (w.plan || 'free');
    const timeStr = w.created_at ? new Date(w.created_at).toLocaleString() : '';
    tr.innerHTML = `
      <td><img class="vtable__thumb" src="${thumbSrc}" alt=""></td>
      <td><div class="vtable__user">${w.username || 'guest'}</div><div class="vtable__email">${w.email || ''}</div></td>
      <td><span class="vtable__age-badge vtable__age-badge--${ageBadge}">~${w.estimated_age || '?'}</span></td>
      <td><span class="vtable__ip">${w.ip_address || ''}</span></td>
      <td><span class="vtable__time">${timeStr}</span></td>
      <td style="text-align:center;font-weight:800;color:#ef4444">${w.total_warnings || 0}</td>
      <td>${planLabel}</td>
    `;
    body.appendChild(tr);
  });
}


// ===== TAB 3: FLAGGED USERS =====
async function loadFlaggedUsers() {
  const list = document.getElementById('userList');
  list.innerHTML = '<div class="loading"><div class="spinner"></div>Loading flagged users...</div>';

  const data = await apiFetch('/admin/warnings/flagged-users');
  if(!data) return;

  const badge = document.getElementById('badgeUsers');
  if(data.count > 0) { badge.textContent = data.count; badge.style.display = 'inline'; }

  if(!data.flagged_users.length) {
    list.innerHTML = '<div class="empty"><svg viewBox="0 0 24 24" style="stroke:#2a3349;fill:none"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="11" x2="19" y2="11.01"/></svg><div class="empty__text">No flagged users.</div></div>';
    return;
  }

  list.innerHTML = '';
  data.flagged_users.forEach(u => {
    const card = document.createElement('div');
    card.className = 'user-card';

    let planClass = 'free', planText = u.plan || 'free';
    if(u.plan === 'suspended') { planClass = 'suspended'; planText = 'SUSPENDED'; }
    else if(u.plan && u.plan !== 'free') { planClass = 'active'; }

    const isSuspended = u.plan === 'suspended';
    const actionBtn = isSuspended
      ? `<button class="btn btn--success" onclick="unsuspendUser('${u.username}', this)">Unsuspend</button>`
      : `<button class="btn btn--danger" onclick="suspendUser('${u.username}', this)">Suspend</button>`;

    card.innerHTML = `
      <div class="user-card__warnings">${u.warnings}</div>
      <div class="user-card__info">
        <div class="user-card__name">${u.username}</div>
        <div class="user-card__email">${u.email || ''}</div>
        <div class="user-card__meta">Joined ${u.created ? u.created.slice(0,10) : '?'} · <span class="user-card__plan user-card__plan--${planClass}">${planText}</span></div>
      </div>
      ${actionBtn}
    `;
    list.appendChild(card);
  });
}

async function suspendUser(username, btn) {
  document.getElementById('confirmTitle').textContent = 'Suspend User';
  document.getElementById('confirmText').innerHTML = `Suspend <strong>${username}</strong>? They will no longer be able to search.`;
  document.getElementById('confirmBtn').textContent = 'Suspend';
  document.getElementById('confirmBtn').className = 'btn btn--danger';
  document.getElementById('confirmBtn').onclick = async () => {
    await apiFetch(`/admin/users/${username}/suspend`, { method: 'POST' });
    document.getElementById('confirmBg').classList.remove('open');
    loadFlaggedUsers();
  };
  document.getElementById('confirmBg').classList.add('open');
}

async function unsuspendUser(username, btn) {
  document.getElementById('confirmTitle').textContent = 'Unsuspend User';
  document.getElementById('confirmText').innerHTML = `Unsuspend <strong>${username}</strong> and reset to free plan?`;
  document.getElementById('confirmBtn').textContent = 'Unsuspend';
  document.getElementById('confirmBtn').className = 'btn btn--success';
  document.getElementById('confirmBtn').onclick = async () => {
    await apiFetch(`/admin/users/${username}/unsuspend`, { method: 'POST' });
    document.getElementById('confirmBg').classList.remove('open');
    loadFlaggedUsers();
  };
  document.getElementById('confirmBg').classList.add('open');
}


// ===== INIT =====
loadStats();
loadFaces();
</script>
</body>
</html>
